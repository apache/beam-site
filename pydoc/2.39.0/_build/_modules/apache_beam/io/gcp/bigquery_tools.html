

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>apache_beam.io.gcp.bigquery_tools &mdash; Apache Beam 2.39.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../../" src="../../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../../index.html" class="icon icon-home"> Apache Beam
          

          
          </a>

          
            
            
              <div class="version">
                2.39.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.coders.html">apache_beam.coders package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.dataframe.html">apache_beam.dataframe package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.io.html">apache_beam.io package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.metrics.html">apache_beam.metrics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.ml.html">apache_beam.ml package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.options.html">apache_beam.options package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.portability.html">apache_beam.portability package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.runners.html">apache_beam.runners package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.testing.html">apache_beam.testing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.transforms.html">apache_beam.transforms package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.typehints.html">apache_beam.typehints package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.utils.html">apache_beam.utils package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.error.html">apache_beam.error module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.pipeline.html">apache_beam.pipeline module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.pvalue.html">apache_beam.pvalue module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Apache Beam</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>apache_beam.io.gcp.bigquery_tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for apache_beam.io.gcp.bigquery_tools</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="c1"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="c1"># this work for additional information regarding copyright ownership.</span>
<span class="c1"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="c1"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="c1"># the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Tools used by BigQuery sources and sinks.</span>

<span class="sd">Classes, constants and functions in this file are experimental and have no</span>
<span class="sd">backwards compatibility guarantees.</span>

<span class="sd">These tools include wrappers and clients to interact with BigQuery APIs.</span>

<span class="sd">NOTHING IN THIS FILE HAS BACKWARDS COMPATIBILITY GUARANTEES.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="c1"># pytype: skip-file</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">json.decoder</span> <span class="kn">import</span> <span class="n">JSONDecodeError</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>

<span class="kn">import</span> <span class="nn">fastavro</span>

<span class="kn">import</span> <span class="nn">apache_beam</span>
<span class="kn">from</span> <span class="nn">apache_beam</span> <span class="kn">import</span> <span class="n">coders</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.gcp</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.gcp.json_value</span> <span class="kn">import</span> <span class="n">from_json_value</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.http_client</span> <span class="kn">import</span> <span class="n">get_new_http</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.metrics.metric</span> <span class="kn">import</span> <span class="n">MetricLogger</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.metrics.metric</span> <span class="kn">import</span> <span class="n">Metrics</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.metrics.metric</span> <span class="kn">import</span> <span class="n">ServiceCallMetric</span>
<span class="kn">from</span> <span class="nn">apache_beam.io.gcp</span> <span class="kn">import</span> <span class="n">bigquery_avro_tools</span>
<span class="kn">from</span> <span class="nn">apache_beam.io.gcp</span> <span class="kn">import</span> <span class="n">resource_identifiers</span>
<span class="kn">from</span> <span class="nn">apache_beam.io.gcp.bigquery_io_metadata</span> <span class="kn">import</span> <span class="n">create_bigquery_io_metadata</span>
<span class="kn">from</span> <span class="nn">apache_beam.io.gcp.internal.clients</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">apache_beam.metrics</span> <span class="kn">import</span> <span class="n">monitoring_infos</span>
<span class="kn">from</span> <span class="nn">apache_beam.options</span> <span class="kn">import</span> <span class="n">value_provider</span>
<span class="kn">from</span> <span class="nn">apache_beam.options.pipeline_options</span> <span class="kn">import</span> <span class="n">GoogleCloudOptions</span>
<span class="kn">from</span> <span class="nn">apache_beam.runners.dataflow.native_io</span> <span class="kn">import</span> <span class="n">iobase</span> <span class="k">as</span> <span class="n">dataflow_io</span>
<span class="kn">from</span> <span class="nn">apache_beam.transforms</span> <span class="kn">import</span> <span class="n">DoFn</span>
<span class="kn">from</span> <span class="nn">apache_beam.typehints.typehints</span> <span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">apache_beam.utils</span> <span class="kn">import</span> <span class="n">retry</span>
<span class="kn">from</span> <span class="nn">apache_beam.utils.histogram</span> <span class="kn">import</span> <span class="n">LinearBucket</span>

<span class="c1"># Protect against environments where bigquery library is not available.</span>
<span class="c1"># pylint: disable=wrong-import-order, wrong-import-position</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">apitools.base.py.transfer</span> <span class="kn">import</span> <span class="n">Upload</span>
  <span class="kn">from</span> <span class="nn">apitools.base.py.exceptions</span> <span class="kn">import</span> <span class="n">HttpError</span><span class="p">,</span> <span class="n">HttpForbiddenError</span>
  <span class="kn">from</span> <span class="nn">google.api_core.exceptions</span> <span class="kn">import</span> <span class="n">ClientError</span><span class="p">,</span> <span class="n">GoogleAPICallError</span>
  <span class="kn">from</span> <span class="nn">google.api_core.client_info</span> <span class="kn">import</span> <span class="n">ClientInfo</span>
  <span class="kn">from</span> <span class="nn">google.cloud</span> <span class="kn">import</span> <span class="n">bigquery</span> <span class="k">as</span> <span class="n">gcp_bigquery</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="n">gcp_bigquery</span> <span class="o">=</span> <span class="kc">None</span>
  <span class="k">pass</span>

<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">orjson</span> <span class="kn">import</span> <span class="n">dumps</span> <span class="k">as</span> <span class="n">fast_json_dumps</span>
  <span class="kn">from</span> <span class="nn">orjson</span> <span class="kn">import</span> <span class="n">loads</span> <span class="k">as</span> <span class="n">fast_json_loads</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="n">fast_json_dumps</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span>
  <span class="n">fast_json_loads</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span>

<span class="c1"># pylint: enable=wrong-import-order, wrong-import-position</span>

<span class="c1"># pylint: disable=wrong-import-order, wrong-import-position, ungrouped-imports</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">apache_beam.io.gcp.internal.clients.bigquery</span> <span class="kn">import</span> <span class="n">TableReference</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="n">TableReference</span> <span class="o">=</span> <span class="kc">None</span>
<span class="c1"># pylint: enable=wrong-import-order, wrong-import-position, ungrouped-imports</span>

<span class="n">_LOGGER</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">JSON_COMPLIANCE_ERROR</span> <span class="o">=</span> <span class="s1">&#39;NAN, INF and -INF values are not JSON compliant.&#39;</span>
<span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">UNKNOWN_MIME_TYPE</span> <span class="o">=</span> <span class="s1">&#39;application/octet-stream&#39;</span>

<span class="c1"># Timeout for a BQ streaming insert RPC. Set to a maximum of 2 minutes.</span>
<span class="n">BQ_STREAMING_INSERT_TIMEOUT_SEC</span> <span class="o">=</span> <span class="mi">120</span>


<div class="viewcode-block" id="FileFormat"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.FileFormat">[docs]</a><span class="k">class</span> <span class="nc">FileFormat</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">CSV</span> <span class="o">=</span> <span class="s1">&#39;CSV&#39;</span>
  <span class="n">JSON</span> <span class="o">=</span> <span class="s1">&#39;NEWLINE_DELIMITED_JSON&#39;</span>
  <span class="n">AVRO</span> <span class="o">=</span> <span class="s1">&#39;AVRO&#39;</span></div>


<div class="viewcode-block" id="ExportCompression"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.ExportCompression">[docs]</a><span class="k">class</span> <span class="nc">ExportCompression</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">GZIP</span> <span class="o">=</span> <span class="s1">&#39;GZIP&#39;</span>
  <span class="n">DEFLATE</span> <span class="o">=</span> <span class="s1">&#39;DEFLATE&#39;</span>
  <span class="n">SNAPPY</span> <span class="o">=</span> <span class="s1">&#39;SNAPPY&#39;</span>
  <span class="n">NONE</span> <span class="o">=</span> <span class="s1">&#39;NONE&#39;</span></div>


<div class="viewcode-block" id="default_encoder"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.default_encoder">[docs]</a><span class="k">def</span> <span class="nf">default_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
    <span class="c1"># on python 3 base64-encoded bytes are decoded to strings</span>
    <span class="c1"># before being sent to BigQuery</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">)):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>

  <span class="n">_LOGGER</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Unable to serialize </span><span class="si">%r</span><span class="s2"> to JSON&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
      <span class="s2">&quot;Object of type &#39;</span><span class="si">%s</span><span class="s2">&#39; is not JSON serializable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_hashable_destination"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.get_hashable_destination">[docs]</a><span class="k">def</span> <span class="nf">get_hashable_destination</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parses a table reference into a (project, dataset, table) tuple.</span>

<span class="sd">  Args:</span>
<span class="sd">    destination: Either a TableReference object from the bigquery API.</span>
<span class="sd">      The object has the following attributes: projectId, datasetId, and</span>
<span class="sd">      tableId. Or a string representing the destination containing</span>
<span class="sd">      &#39;PROJECT:DATASET.TABLE&#39;.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A string representing the destination containing</span>
<span class="sd">    &#39;PROJECT:DATASET.TABLE&#39;.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">TableReference</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">destination</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="n">destination</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">destination</span></div>


<span class="n">V</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="to_hashable_table_ref"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.to_hashable_table_ref">[docs]</a><span class="k">def</span> <span class="nf">to_hashable_table_ref</span><span class="p">(</span>
    <span class="n">table_ref_elem_kv</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">TableReference</span><span class="p">],</span> <span class="n">V</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">V</span><span class="p">]:</span>
  <span class="sd">&quot;&quot;&quot;Turns the key of the input tuple to its string representation. The key</span>
<span class="sd">  should be either a string or a TableReference.</span>

<span class="sd">  Args:</span>
<span class="sd">    table_ref_elem_kv: A tuple of table reference and element.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A tuple of string representation of input table and input element.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">table_ref</span> <span class="o">=</span> <span class="n">table_ref_elem_kv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">hashable_table_ref</span> <span class="o">=</span> <span class="n">get_hashable_destination</span><span class="p">(</span><span class="n">table_ref</span><span class="p">)</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">hashable_table_ref</span><span class="p">,</span> <span class="n">table_ref_elem_kv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="parse_table_schema_from_json"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.parse_table_schema_from_json">[docs]</a><span class="k">def</span> <span class="nf">parse_table_schema_from_json</span><span class="p">(</span><span class="n">schema_string</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parse the Table Schema provided as string.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema_string: String serialized table schema, should be a valid JSON.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A TableSchema of the BigQuery export from either the Query or the Table.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">json_schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">schema_string</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
        <span class="s1">&#39;Unable to parse JSON schema: </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema_string</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">_parse_schema_field</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a single schema field from dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">      field: Dictionary object containing serialized schema.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A TableFieldSchema for a single column in BigQuery.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">()</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;NULLABLE&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;fields&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_schema_field</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">schema</span>

  <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_schema_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">json_schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]]</span>
  <span class="k">return</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_table_reference"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.parse_table_reference">[docs]</a><span class="k">def</span> <span class="nf">parse_table_reference</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parses a table reference into a (project, dataset, table) tuple.</span>

<span class="sd">  Args:</span>
<span class="sd">    table: The ID of the table. The ID must contain only letters</span>
<span class="sd">      (a-z, A-Z), numbers (0-9), connectors (-_). If dataset argument is None</span>
<span class="sd">      then the table argument must contain the entire table reference:</span>
<span class="sd">      &#39;DATASET.TABLE&#39; or &#39;PROJECT:DATASET.TABLE&#39;. This argument can be a</span>
<span class="sd">      TableReference instance in which case dataset and project are</span>
<span class="sd">      ignored and the reference is returned as a result.  Additionally, for date</span>
<span class="sd">      partitioned tables, appending &#39;$YYYYmmdd&#39; to the table name is supported,</span>
<span class="sd">      e.g. &#39;DATASET.TABLE$YYYYmmdd&#39;.</span>
<span class="sd">    dataset: The ID of the dataset containing this table or null if the table</span>
<span class="sd">      reference is specified entirely by the table argument.</span>
<span class="sd">    project: The ID of the project containing this table or null if the table</span>
<span class="sd">      reference is specified entirely by the table (and possibly dataset)</span>
<span class="sd">      argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A TableReference object from the bigquery API. The object has the following</span>
<span class="sd">    attributes: projectId, datasetId, and tableId.</span>
<span class="sd">    If the input is a TableReference object, a new object will be returned.</span>

<span class="sd">  Raises:</span>
<span class="sd">    ValueError: if the table reference as a string does not match the expected</span>
<span class="sd">      format.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">TableReference</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">TableReference</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span>
        <span class="n">datasetId</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span>
        <span class="n">tableId</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
  <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">ValueProvider</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table</span>

  <span class="n">table_reference</span> <span class="o">=</span> <span class="n">TableReference</span><span class="p">()</span>
  <span class="c1"># If dataset argument is not specified, the expectation is that the</span>
  <span class="c1"># table argument will contain a full table reference instead of just a</span>
  <span class="c1"># table name.</span>
  <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^((?P&lt;project&gt;.+):)?(?P&lt;dataset&gt;\w+)\.(?P&lt;table&gt;[-\w\$]+)$&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Expected a table reference (PROJECT:DATASET.TABLE or &#39;</span>
          <span class="s1">&#39;DATASET.TABLE) instead of </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span> <span class="o">=</span> <span class="n">dataset</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span> <span class="o">=</span> <span class="n">table</span>
  <span class="k">return</span> <span class="n">table_reference</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># BigQueryWrapper.</span>


<span class="k">def</span> <span class="nf">_build_job_labels</span><span class="p">(</span><span class="n">input_labels</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Builds job label protobuf structure.&quot;&quot;&quot;</span>
  <span class="n">input_labels</span> <span class="o">=</span> <span class="n">input_labels</span> <span class="ow">or</span> <span class="p">{}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="o">.</span><span class="n">LabelsValue</span><span class="p">()</span>

  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">result</span><span class="o">.</span><span class="n">additionalProperties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="o">.</span><span class="n">LabelsValue</span><span class="o">.</span><span class="n">AdditionalProperty</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
        <span class="p">))</span>
  <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_build_dataset_labels</span><span class="p">(</span><span class="n">input_labels</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Builds dataset label protobuf structure.&quot;&quot;&quot;</span>
  <span class="n">input_labels</span> <span class="o">=</span> <span class="n">input_labels</span> <span class="ow">or</span> <span class="p">{}</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">LabelsValue</span><span class="p">()</span>

  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">input_labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">result</span><span class="o">.</span><span class="n">additionalProperties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">bigquery</span><span class="o">.</span><span class="n">Dataset</span><span class="o">.</span><span class="n">LabelsValue</span><span class="o">.</span><span class="n">AdditionalProperty</span><span class="p">(</span>
            <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span>
            <span class="n">value</span><span class="o">=</span><span class="n">v</span><span class="p">,</span>
        <span class="p">))</span>
  <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">_build_filter_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">):</span>
  <span class="n">filter_str</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">labels</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">filter_str</span> <span class="o">+=</span> <span class="s1">&#39;labels.&#39;</span> <span class="o">+</span> <span class="n">key</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span> <span class="o">+</span> <span class="n">value</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span>
  <span class="k">return</span> <span class="n">filter_str</span>


<div class="viewcode-block" id="BigQueryWrapper"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper">[docs]</a><span class="k">class</span> <span class="nc">BigQueryWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;BigQuery client wrapper with utilities for querying.</span>

<span class="sd">  The wrapper is used to organize all the BigQuery integration points and</span>
<span class="sd">  offer a common place where retry logic for failures can be controlled.</span>
<span class="sd">  In addition, it offers various functions used both in sources and sinks</span>
<span class="sd">  (e.g., find and create tables, query a table, etc.).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="c1"># If updating following names, also update the corresponding pydocs in</span>
  <span class="c1"># bigquery.py.</span>
  <span class="n">TEMP_TABLE</span> <span class="o">=</span> <span class="s1">&#39;beam_temp_table_&#39;</span>
  <span class="n">TEMP_DATASET</span> <span class="o">=</span> <span class="s1">&#39;beam_temp_dataset_&#39;</span>

  <span class="n">HISTOGRAM_METRIC_LOGGER</span> <span class="o">=</span> <span class="n">MetricLogger</span><span class="p">()</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp_dataset_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp_table_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span> <span class="ow">or</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryV2</span><span class="p">(</span>
        <span class="n">http</span><span class="o">=</span><span class="n">get_new_http</span><span class="p">(),</span>
        <span class="n">credentials</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">get_service_credentials</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
        <span class="n">response_encoding</span><span class="o">=</span><span class="s1">&#39;utf8&#39;</span><span class="p">,</span>
        <span class="n">additional_http_headers</span><span class="o">=</span><span class="p">{</span>
            <span class="s2">&quot;user-agent&quot;</span><span class="p">:</span> <span class="s2">&quot;apache-beam-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">apache_beam</span><span class="o">.</span><span class="n">__version__</span>
        <span class="p">})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">gcp_bq_client</span> <span class="o">=</span> <span class="n">client</span> <span class="ow">or</span> <span class="n">gcp_bigquery</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span>
        <span class="n">client_info</span><span class="o">=</span><span class="n">ClientInfo</span><span class="p">(</span>
            <span class="n">user_agent</span><span class="o">=</span><span class="s2">&quot;apache-beam-</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">apache_beam</span><span class="o">.</span><span class="n">__version__</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># For testing scenarios where we pass in a client we do not want a</span>
    <span class="c1"># randomized prefix for row IDs.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_row_id_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">client</span> <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_latency_histogram_metric</span> <span class="o">=</span> <span class="n">Metrics</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">,</span>
        <span class="s1">&#39;latency_histogram_ms&#39;</span><span class="p">,</span>
        <span class="n">LinearBucket</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">3000</span><span class="p">),</span>
        <span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">HISTOGRAM_METRIC_LOGGER</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">temp_dataset_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">temp_table_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Both a BigQuery temp_dataset_id and a temp_table_ref were specified.&#39;</span>
          <span class="s1">&#39; Please specify only one of these.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">temp_dataset_id</span> <span class="ow">and</span> <span class="n">temp_dataset_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEMP_DATASET</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;User provided temp dataset ID cannot start with </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">TEMP_DATASET</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">temp_table_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span> <span class="o">=</span> <span class="n">temp_table_ref</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span> <span class="o">=</span> <span class="n">temp_table_ref</span><span class="o">.</span><span class="n">datasetId</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span> <span class="o">=</span> <span class="n">temp_dataset_id</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_dataset</span><span class="p">()</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">created_temp_dataset</span> <span class="o">=</span> <span class="kc">False</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">unique_row_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a unique row ID (str) used to avoid multiple insertions.</span>

<span class="sd">    If the row ID is provided, BigQuery will make a best effort to not insert</span>
<span class="sd">    the same row multiple times for fail and retry scenarios in which the insert</span>
<span class="sd">    request may be issued several times. This comes into play for sinks executed</span>
<span class="sd">    in a local runner.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a unique row ID string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_id_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_temp_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span>

    <span class="k">return</span> <span class="n">parse_table_reference</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">TEMP_TABLE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_temp_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_table_ref</span><span class="o">.</span><span class="n">datasetId</span>
    <span class="k">return</span> <span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">TEMP_DATASET</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span>

<div class="viewcode-block" id="BigQueryWrapper.get_query_location"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_query_location">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_query_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">use_legacy_sql</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the location of tables referenced in a query.</span>

<span class="sd">    This method returns the location of the first available referenced</span>
<span class="sd">    table for user in the query and depends on the BigQuery service to</span>
<span class="sd">    provide error handling for queries that reference tables in multiple</span>
<span class="sd">    locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span>
        <span class="n">jobId</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">dryRun</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationQuery</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">useLegacySql</span><span class="o">=</span><span class="n">use_legacy_sql</span><span class="p">,</span>
                <span class="p">)),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">statistics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># This behavior is only expected in tests</span>
      <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;Unable to get location, missing response.statistics. Query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="n">query</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">None</span>

    <span class="n">referenced_tables</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">statistics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">referencedTables</span>
    <span class="k">if</span> <span class="n">referenced_tables</span><span class="p">:</span>  <span class="c1"># Guards against both non-empty and non-None</span>
      <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">referenced_tables</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_location</span><span class="p">(</span>
              <span class="n">table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HttpForbiddenError</span><span class="p">:</span>
          <span class="c1"># Permission access for table (i.e. from authorized_view),</span>
          <span class="c1"># try next one</span>
          <span class="k">continue</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Using location </span><span class="si">%r</span><span class="s2"> from table </span><span class="si">%r</span><span class="s2"> referenced by query </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">location</span><span class="p">,</span>
            <span class="n">table</span><span class="p">,</span>
            <span class="n">query</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">location</span>

    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
        <span class="s2">&quot;Query </span><span class="si">%s</span><span class="s2"> does not reference any tables or &quot;</span>
        <span class="s2">&quot;you don&#39;t have permission to inspect them.&quot;</span><span class="p">,</span>
        <span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_copy_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">from_table_reference</span><span class="p">,</span>
      <span class="n">to_table_reference</span><span class="p">,</span>
      <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">()</span>
    <span class="n">reference</span><span class="o">.</span><span class="n">jobId</span> <span class="o">=</span> <span class="n">job_id</span>
    <span class="n">reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project_id</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">copy</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationTableCopy</span><span class="p">(</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="n">to_table_reference</span><span class="p">,</span>
                    <span class="n">sourceTable</span><span class="o">=</span><span class="n">from_table_reference</span><span class="p">,</span>
                    <span class="n">createDisposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
                    <span class="n">writeDisposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">_build_job_labels</span><span class="p">(</span><span class="n">job_labels</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
        <span class="p">))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_job</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">jobReference</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_load_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">table_reference</span><span class="p">,</span>
      <span class="n">source_uris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">source_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">additional_load_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">source_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">source_uris</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">source_stream</span><span class="p">:</span>
      <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s1">&#39;Both source URIs and source stream are not provided. BigQuery load &#39;</span>
          <span class="s1">&#39;job will not load any data.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source_uris</span> <span class="ow">and</span> <span class="n">source_stream</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Only one of source_uris and source_stream may be specified. &#39;</span>
          <span class="s1">&#39;Got both.&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">source_uris</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">source_uris</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">additional_load_parameters</span> <span class="o">=</span> <span class="n">additional_load_parameters</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">job_schema</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">schema</span> <span class="o">==</span> <span class="s1">&#39;SCHEMA_AUTODETECT&#39;</span> <span class="k">else</span> <span class="n">schema</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">load</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationLoad</span><span class="p">(</span>
                    <span class="n">sourceUris</span><span class="o">=</span><span class="n">source_uris</span><span class="p">,</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="n">table_reference</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="n">job_schema</span><span class="p">,</span>
                    <span class="n">writeDisposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
                    <span class="n">createDisposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
                    <span class="n">sourceFormat</span><span class="o">=</span><span class="n">source_format</span><span class="p">,</span>
                    <span class="n">useAvroLogicalTypes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">autodetect</span><span class="o">=</span><span class="n">schema</span> <span class="o">==</span> <span class="s1">&#39;SCHEMA_AUTODETECT&#39;</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_load_parameters</span><span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">_build_job_labels</span><span class="p">(</span><span class="n">job_labels</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_job</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">source_stream</span><span class="p">)</span><span class="o">.</span><span class="n">jobReference</span>

  <span class="k">def</span> <span class="nf">_start_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">request</span><span class="p">,</span>  <span class="c1"># type: bigquery.BigqueryJobsInsertRequest</span>
      <span class="n">stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
  <span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inserts a BigQuery job.</span>

<span class="sd">    If the job exists already, it returns it.</span>

<span class="sd">    Args:</span>
<span class="sd">      request (bigquery.BigqueryJobsInsertRequest): An insert job request.</span>
<span class="sd">      stream (IO[bytes]): A bytes IO object open for reading.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">upload</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">upload</span> <span class="o">=</span> <span class="n">Upload</span><span class="o">.</span><span class="n">FromStream</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">mime_type</span><span class="o">=</span><span class="n">UNKNOWN_MIME_TYPE</span><span class="p">)</span>
      <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">upload</span><span class="o">=</span><span class="n">upload</span><span class="p">)</span>
      <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s2">&quot;Started BigQuery job: </span><span class="si">%s</span><span class="se">\n</span><span class="s2"> &quot;</span>
          <span class="s2">&quot;bq show -j --format=prettyjson --project_id=</span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span><span class="p">,</span>
          <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span>
          <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">jobId</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">response</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;BigQuery job </span><span class="si">%s</span><span class="s2"> already exists, will not retry inserting it: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="n">request</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">jobReference</span><span class="p">,</span>
            <span class="n">exn</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">request</span><span class="o">.</span><span class="n">job</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="s2">&quot;Failed to insert job </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">job</span><span class="o">.</span><span class="n">jobReference</span><span class="p">,</span> <span class="n">exn</span><span class="p">)</span>
        <span class="k">raise</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_start_query_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">query</span><span class="p">,</span>
      <span class="n">use_legacy_sql</span><span class="p">,</span>
      <span class="n">flatten_results</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">priority</span><span class="p">,</span>
      <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">kms_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">dryRun</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationQuery</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">useLegacySql</span><span class="o">=</span><span class="n">use_legacy_sql</span><span class="p">,</span>
                    <span class="n">allowLargeResults</span><span class="o">=</span><span class="ow">not</span> <span class="n">dry_run</span><span class="p">,</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="n">flattenResults</span><span class="o">=</span><span class="n">flatten_results</span><span class="p">,</span>
                    <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
                    <span class="n">destinationEncryptionConfiguration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span>
                    <span class="n">EncryptionConfiguration</span><span class="p">(</span><span class="n">kmsKeyName</span><span class="o">=</span><span class="n">kms_key</span><span class="p">)),</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">_build_job_labels</span><span class="p">(</span><span class="n">job_labels</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">))</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_job</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

<div class="viewcode-block" id="BigQueryWrapper.wait_for_bq_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.wait_for_bq_job">[docs]</a>  <span class="k">def</span> <span class="nf">wait_for_bq_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_reference</span><span class="p">,</span> <span class="n">sleep_duration_sec</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">max_retries</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Poll job until it is DONE.</span>

<span class="sd">    Args:</span>
<span class="sd">      job_reference: bigquery.JobReference instance.</span>
<span class="sd">      sleep_duration_sec: Specifies the delay in seconds between retries.</span>
<span class="sd">      max_retries: The total number of times to retry. If equals to 0,</span>
<span class="sd">        the function waits forever.</span>

<span class="sd">    Raises:</span>
<span class="sd">      `RuntimeError`: If the job is FAILED or the number of retries has been</span>
<span class="sd">        reached.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retry</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">retry</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_job</span><span class="p">(</span>
          <span class="n">job_reference</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">job_reference</span><span class="o">.</span><span class="n">jobId</span><span class="p">,</span> <span class="n">job_reference</span><span class="o">.</span><span class="n">location</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Job status: </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;DONE&#39;</span> <span class="ow">and</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">errorResult</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;BigQuery job </span><span class="si">{}</span><span class="s1"> failed. Error Result: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">job_reference</span><span class="o">.</span><span class="n">jobId</span><span class="p">,</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">errorResult</span><span class="p">))</span>
      <span class="k">elif</span> <span class="n">job</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;DONE&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">sleep_duration_sec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">max_retries</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">retry</span> <span class="o">&gt;=</span> <span class="n">max_retries</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The maximum number of retries has been reached&#39;</span><span class="p">)</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_get_query_results</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">page_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">max_results</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span>
      <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsGetQueryResultsRequest</span><span class="p">(</span>
        <span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span>
        <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">,</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">maxResults</span><span class="o">=</span><span class="n">max_results</span><span class="p">,</span>
        <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">GetQueryResults</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_timeout_or_quota_issues_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_all_rows</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">dataset_id</span><span class="p">,</span>
      <span class="n">table_id</span><span class="p">,</span>
      <span class="n">rows</span><span class="p">,</span>
      <span class="n">insert_ids</span><span class="p">,</span>
      <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">ignore_unknown_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls the insertAll BigQuery API endpoint.</span>

<span class="sd">    Docs for this BQ call: https://cloud.google.com/bigquery/docs/reference\</span>
<span class="sd">      /rest/v2/tabledata/insertAll.&quot;&quot;&quot;</span>
    <span class="c1"># The rows argument is a list of</span>
    <span class="c1"># bigquery.TableDataInsertAllRequest.RowsValueListEntry instances as</span>
    <span class="c1"># required by the InsertAll() method.</span>
    <span class="n">resource</span> <span class="o">=</span> <span class="n">resource_identifiers</span><span class="o">.</span><span class="n">BigQueryTable</span><span class="p">(</span>
        <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>

    <span class="n">labels</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># TODO(ajamato): Add Ptransform label.</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">SERVICE_LABEL</span><span class="p">:</span> <span class="s1">&#39;BigQuery&#39;</span><span class="p">,</span>
        <span class="c1"># Refer to any method which writes elements to BigQuery in batches</span>
        <span class="c1"># as &quot;BigQueryBatchWrite&quot;. I.e. storage API&#39;s insertAll, or future</span>
        <span class="c1"># APIs introduced.</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">METHOD_LABEL</span><span class="p">:</span> <span class="s1">&#39;BigQueryBatchWrite&#39;</span><span class="p">,</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">RESOURCE_LABEL</span><span class="p">:</span> <span class="n">resource</span><span class="p">,</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">BIGQUERY_PROJECT_ID_LABEL</span><span class="p">:</span> <span class="n">project_id</span><span class="p">,</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">BIGQUERY_DATASET_LABEL</span><span class="p">:</span> <span class="n">dataset_id</span><span class="p">,</span>
        <span class="n">monitoring_infos</span><span class="o">.</span><span class="n">BIGQUERY_TABLE_LABEL</span><span class="p">:</span> <span class="n">table_id</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">service_call_metric</span> <span class="o">=</span> <span class="n">ServiceCallMetric</span><span class="p">(</span>
        <span class="n">request_count_urn</span><span class="o">=</span><span class="n">monitoring_infos</span><span class="o">.</span><span class="n">API_REQUEST_COUNT_URN</span><span class="p">,</span>
        <span class="n">base_labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>

    <span class="n">started_millis</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">table_ref_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
      <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gcp_bq_client</span><span class="o">.</span><span class="n">insert_rows_json</span><span class="p">(</span>
          <span class="n">table_ref_str</span><span class="p">,</span>
          <span class="n">json_rows</span><span class="o">=</span><span class="n">rows</span><span class="p">,</span>
          <span class="n">row_ids</span><span class="o">=</span><span class="n">insert_ids</span><span class="p">,</span>
          <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="n">skip_invalid_rows</span><span class="p">,</span>
          <span class="n">ignore_unknown_values</span><span class="o">=</span><span class="n">ignore_unknown_values</span><span class="p">,</span>
          <span class="n">timeout</span><span class="o">=</span><span class="n">BQ_STREAMING_INSERT_TIMEOUT_SEC</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">:</span>
        <span class="n">service_call_metric</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="s1">&#39;ok&#39;</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">insert_error</span> <span class="ow">in</span> <span class="n">errors</span><span class="p">:</span>
          <span class="n">service_call_metric</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">insert_error</span><span class="p">[</span><span class="s1">&#39;errors&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="n">ClientError</span><span class="p">,</span> <span class="n">GoogleAPICallError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="c1"># e.code contains the numeric http status code.</span>
      <span class="n">service_call_metric</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
      <span class="c1"># Re-reise the exception so that we re-try appropriately.</span>
      <span class="k">raise</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">service_call_metric</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
      <span class="c1"># Re-reise the exception so that we re-try appropriately.</span>
      <span class="k">raise</span>
    <span class="k">finally</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_latency_histogram_metric</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
          <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">-</span> <span class="n">started_millis</span><span class="p">)</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">errors</span><span class="p">,</span> <span class="n">errors</span>

<div class="viewcode-block" id="BigQueryWrapper.get_table"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_table">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup a table&#39;s metadata object.</span>

<span class="sd">    Args:</span>
<span class="sd">      client: bigquery.BigqueryV2 instance</span>
<span class="sd">      project_id: table lookup parameter</span>
<span class="sd">      dataset_id: table lookup parameter</span>
<span class="sd">      table_id: table lookup parameter</span>

<span class="sd">    Returns:</span>
<span class="sd">      bigquery.Table instance</span>
<span class="sd">    Raises:</span>
<span class="sd">      HttpError: if lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesGetRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>

  <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">dataset_id</span><span class="p">,</span>
      <span class="n">table_id</span><span class="p">,</span>
      <span class="n">schema</span><span class="p">,</span>
      <span class="n">additional_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">valid_tablename</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^[\w]{1,1024}$&#39;</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">ASCII</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_tablename</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Invalid BigQuery table name: </span><span class="si">%s</span><span class="s1"> </span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39;A table name in BigQuery must contain only letters (a-z, A-Z), &#39;</span>
          <span class="s1">&#39;numbers (0-9), or underscores (_) and be up to 1024 characters:</span><span class="se">\n</span><span class="s1">&#39;</span>
          <span class="s1">&#39;See https://cloud.google.com/bigquery/docs/tables#table_naming&#39;</span> <span class="o">%</span>
          <span class="n">table_id</span><span class="p">)</span>

    <span class="n">additional_parameters</span> <span class="o">=</span> <span class="n">additional_parameters</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
        <span class="n">tableReference</span><span class="o">=</span><span class="n">TableReference</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">),</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
        <span class="o">**</span><span class="n">additional_parameters</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created the table with id </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="c1"># The response is a bigquery.Table instance.</span>
    <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="BigQueryWrapper.get_or_create_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_or_create_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_or_create_dataset</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check if dataset already exists otherwise create it</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span>
          <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
              <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">))</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">created_temp_dataset</span> <span class="o">=</span> <span class="kc">False</span>
      <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">dataset_reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">DatasetReference</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">datasetReference</span><span class="o">=</span><span class="n">dataset_reference</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">dataset</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">dataset</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">_build_dataset_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsInsertRequest</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">created_temp_dataset</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># The response is a bigquery.Dataset instance.</span>
        <span class="k">return</span> <span class="n">response</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_is_table_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTabledataListRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
        <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
        <span class="n">maxResults</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tabledata</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># The response is a bigquery.TableDataList instance.</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">totalRows</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_delete_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesDeleteRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_delete_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">delete_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsDeleteRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
        <span class="n">deleteContents</span><span class="o">=</span><span class="n">delete_contents</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

<div class="viewcode-block" id="BigQueryWrapper.get_table_location"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_table_location">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_table_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">location</span></div>

  <span class="c1"># Returns true if the temporary dataset was provided by the user.</span>
<div class="viewcode-block" id="BigQueryWrapper.is_user_configured_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.is_user_configured_dataset">[docs]</a>  <span class="k">def</span> <span class="nf">is_user_configured_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span> <span class="ow">and</span>
        <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">TEMP_DATASET</span><span class="p">))</span></div>

<div class="viewcode-block" id="BigQueryWrapper.create_temporary_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.create_temporary_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">create_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check if dataset exists to make sure that the temporary id is unique</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span>
          <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
              <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">project_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_configured_dataset</span><span class="p">():</span>
        <span class="c1"># Unittests don&#39;t pass projectIds so they can be run without error</span>
        <span class="c1"># User configured datasets are allowed to pre-exist.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> already exists so cannot be used as temporary.&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist so we will create it as temporary &#39;</span>
            <span class="s1">&#39;with location=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">project_id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="p">,</span>
            <span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_dataset</span><span class="p">(</span>
            <span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_dataset_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="BigQueryWrapper.clean_up_temporary_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.clean_up_temporary_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">clean_up_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="n">temp_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span>
          <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
              <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># We do not want to delete temporary datasets configured by the user hence</span>
      <span class="c1"># we just delete the temporary table in that case.</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_configured_dataset</span><span class="p">():</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_dataset</span><span class="p">(</span><span class="n">temp_table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_table</span><span class="p">(</span>
            <span class="n">temp_table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="n">temp_table</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">created_temp_dataset</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Permission denied to delete temporary dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> for clean up&#39;</span><span class="p">,</span>
            <span class="n">temp_table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span>
            <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_clean_up_beam_labelled_temporary_datasets</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">table_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
      <span class="n">filter_str</span> <span class="o">=</span> <span class="n">_build_filter_from_labels</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_user_configured_dataset</span><span class="p">()</span> <span class="ow">and</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">response</span> <span class="o">=</span> <span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">List</span><span class="p">(</span>
              <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsListRequest</span><span class="p">(</span>
                  <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">filter_str</span><span class="p">)))</span>
      <span class="k">for</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">datasets</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">datasetReference</span><span class="o">.</span><span class="n">datasetId</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_delete_dataset</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
          <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
            <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s1">&#39;Permission denied to delete temporary dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> for &#39;</span>
                <span class="s1">&#39;clean up.&#39;</span><span class="p">,</span>
                <span class="n">project_id</span><span class="p">,</span>
                <span class="n">dataset_id</span><span class="p">)</span>
            <span class="k">return</span>
          <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">403</span><span class="p">:</span>
          <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
              <span class="s1">&#39;Permission denied to delete temporary table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> for &#39;</span>
              <span class="s1">&#39;clean up.&#39;</span><span class="p">,</span>
              <span class="n">project_id</span><span class="p">,</span>
              <span class="n">dataset_id</span><span class="p">,</span>
              <span class="n">table_id</span><span class="p">)</span>
          <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span>

<div class="viewcode-block" id="BigQueryWrapper.get_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_job">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsGetRequest</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">jobId</span> <span class="o">=</span> <span class="n">job_id</span>
    <span class="n">request</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project</span>
    <span class="n">request</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="BigQueryWrapper.perform_load_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.perform_load_job">[docs]</a>  <span class="k">def</span> <span class="nf">perform_load_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">destination</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">source_uris</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">source_stream</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">additional_load_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">source_format</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">load_job_project_id</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a job to load data into BigQuery.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bigquery.JobReference with the information about the job that was started.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project_id</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">projectId</span>
        <span class="k">if</span> <span class="n">load_job_project_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">load_job_project_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_load_job</span><span class="p">(</span>
        <span class="n">project_id</span><span class="p">,</span>
        <span class="n">job_id</span><span class="p">,</span>
        <span class="n">destination</span><span class="p">,</span>
        <span class="n">source_uris</span><span class="o">=</span><span class="n">source_uris</span><span class="p">,</span>
        <span class="n">source_stream</span><span class="o">=</span><span class="n">source_stream</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
        <span class="n">create_disposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
        <span class="n">write_disposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
        <span class="n">additional_load_parameters</span><span class="o">=</span><span class="n">additional_load_parameters</span><span class="p">,</span>
        <span class="n">source_format</span><span class="o">=</span><span class="n">source_format</span><span class="p">,</span>
        <span class="n">job_labels</span><span class="o">=</span><span class="n">job_labels</span><span class="p">)</span></div>

<div class="viewcode-block" id="BigQueryWrapper.perform_extract_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.perform_extract_job">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">perform_extract_job</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">destination</span><span class="p">,</span>
      <span class="n">job_id</span><span class="p">,</span>
      <span class="n">table_reference</span><span class="p">,</span>
      <span class="n">destination_format</span><span class="p">,</span>
      <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">include_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">compression</span><span class="o">=</span><span class="n">ExportCompression</span><span class="o">.</span><span class="n">NONE</span><span class="p">,</span>
      <span class="n">use_avro_logical_types</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a job to export data from BigQuery.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bigquery.JobReference with the information about the job that was started.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">job_project</span> <span class="o">=</span> <span class="n">project</span> <span class="ow">or</span> <span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span>
    <span class="n">job_reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">job_project</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">job_project</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">extract</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationExtract</span><span class="p">(</span>
                    <span class="n">destinationUris</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
                    <span class="n">sourceTable</span><span class="o">=</span><span class="n">table_reference</span><span class="p">,</span>
                    <span class="n">printHeader</span><span class="o">=</span><span class="n">include_header</span><span class="p">,</span>
                    <span class="n">destinationFormat</span><span class="o">=</span><span class="n">destination_format</span><span class="p">,</span>
                    <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                    <span class="n">useAvroLogicalTypes</span><span class="o">=</span><span class="n">use_avro_logical_types</span><span class="p">,</span>
                <span class="p">),</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">_build_job_labels</span><span class="p">(</span><span class="n">job_labels</span><span class="p">),</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">job_reference</span><span class="p">,</span>
        <span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_job</span><span class="p">(</span><span class="n">request</span><span class="p">)</span><span class="o">.</span><span class="n">jobReference</span></div>

<div class="viewcode-block" id="BigQueryWrapper.get_or_create_table"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.get_or_create_table">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span>
      <span class="n">retry_if_valid_input_but_server_error_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_or_create_table</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">dataset_id</span><span class="p">,</span>
      <span class="n">table_id</span><span class="p">,</span>
      <span class="n">schema</span><span class="p">,</span>
      <span class="n">create_disposition</span><span class="p">,</span>
      <span class="n">write_disposition</span><span class="p">,</span>
      <span class="n">additional_create_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets or creates a table based on create and write dispositions.</span>

<span class="sd">    The function mimics the behavior of BigQuery import jobs when using the</span>
<span class="sd">    same create and write dispositions.</span>

<span class="sd">    Args:</span>
<span class="sd">      project_id: The project id owning the table.</span>
<span class="sd">      dataset_id: The dataset id owning the table.</span>
<span class="sd">      table_id: The table id.</span>
<span class="sd">      schema: A bigquery.TableSchema instance or None.</span>
<span class="sd">      create_disposition: CREATE_NEVER or CREATE_IF_NEEDED.</span>
<span class="sd">      write_disposition: WRITE_APPEND, WRITE_EMPTY or WRITE_TRUNCATE.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A bigquery.Table instance if table was found or created.</span>

<span class="sd">    Raises:</span>
<span class="sd">      `RuntimeError`: For various mismatches between the state of the table and</span>
<span class="sd">        the create/write dispositions passed in. For example if the table is not</span>
<span class="sd">        empty and WRITE_EMPTY was specified then an error will be raised since</span>
<span class="sd">        the table was expected to be empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">apache_beam.io.gcp.bigquery</span> <span class="kn">import</span> <span class="n">BigQueryDisposition</span>

    <span class="n">found_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">found_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">create_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">CREATE_NEVER</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
              <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> not found but create disposition is CREATE_NEVER.&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="c1"># If table exists already then handle the semantics for WRITE_EMPTY and</span>
    <span class="c1"># WRITE_TRUNCATE write dispositions.</span>
    <span class="k">if</span> <span class="n">found_table</span> <span class="ow">and</span> <span class="n">write_disposition</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_EMPTY</span><span class="p">,</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">):</span>
      <span class="c1"># Delete the table and recreate it (later) if WRITE_TRUNCATE was</span>
      <span class="c1"># specified.</span>
      <span class="k">if</span> <span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
      <span class="k">elif</span> <span class="p">(</span><span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_EMPTY</span> <span class="ow">and</span>
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_table_empty</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> is not empty but write disposition is WRITE_EMPTY.&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>

    <span class="c1"># Create a new table potentially reusing the schema from a previously</span>
    <span class="c1"># found table in case the schema was not specified.</span>
    <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">found_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
          <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> requires a schema. None can be inferred because the &#39;</span>
          <span class="s1">&#39;table does not exist.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">found_table</span> <span class="ow">and</span> <span class="n">write_disposition</span> <span class="o">!=</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">found_table</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">created_table</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">created_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span>
            <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
            <span class="n">table_id</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="ow">or</span> <span class="n">found_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">additional_parameters</span><span class="o">=</span><span class="n">additional_create_parameters</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span><span class="p">:</span>
          <span class="n">_LOGGER</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
              <span class="s1">&#39;Skipping Creation. Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> already exists.&#39;</span> <span class="o">%</span>
              <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
          <span class="n">created_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span>
      <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;Created table </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> with schema </span><span class="si">%s</span><span class="s1">. &#39;</span>
          <span class="s1">&#39;Result: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
          <span class="n">project_id</span><span class="p">,</span>
          <span class="n">dataset_id</span><span class="p">,</span>
          <span class="n">table_id</span><span class="p">,</span>
          <span class="n">schema</span> <span class="ow">or</span> <span class="n">found_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
          <span class="n">created_table</span><span class="p">)</span>
      <span class="c1"># if write_disposition == BigQueryDisposition.WRITE_TRUNCATE we delete</span>
      <span class="c1"># the table before this point.</span>
      <span class="k">if</span> <span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
        <span class="c1"># BigQuery can route data to the old table for 2 mins max so wait</span>
        <span class="c1"># that much time before creating the table and writing it</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Sleeping for 150 seconds before the write as &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;BigQuery inserts can be routed to deleted table &#39;</span> <span class="o">+</span>
            <span class="s1">&#39;for 2 mins after the delete and create.&#39;</span><span class="p">)</span>
        <span class="c1"># TODO(BEAM-2673): Remove this sleep by migrating to load api</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">created_table</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">created_table</span></div>

<div class="viewcode-block" id="BigQueryWrapper.run_query"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.run_query">[docs]</a>  <span class="k">def</span> <span class="nf">run_query</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">query</span><span class="p">,</span>
      <span class="n">use_legacy_sql</span><span class="p">,</span>
      <span class="n">flatten_results</span><span class="p">,</span>
      <span class="n">priority</span><span class="p">,</span>
      <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">job_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">job</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_query_job</span><span class="p">(</span>
        <span class="n">project_id</span><span class="p">,</span>
        <span class="n">query</span><span class="p">,</span>
        <span class="n">use_legacy_sql</span><span class="p">,</span>
        <span class="n">flatten_results</span><span class="p">,</span>
        <span class="n">job_id</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="n">priority</span><span class="p">,</span>
        <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
        <span class="n">job_labels</span><span class="o">=</span><span class="n">job_labels</span><span class="p">)</span>
    <span class="n">job_id</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">jobId</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">job</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">location</span>

    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
      <span class="c1"># If this was a dry run then the fact that we get here means the</span>
      <span class="c1"># query has no errors. The start_query_job would raise an error otherwise.</span>
      <span class="k">return</span>
    <span class="n">page_token</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query_results</span><span class="p">(</span>
          <span class="n">project_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">page_token</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">jobComplete</span><span class="p">:</span>
        <span class="c1"># The jobComplete field can be False if the query request times out</span>
        <span class="c1"># (default is 10 seconds). Note that this is a timeout for the query</span>
        <span class="c1"># request not for the actual execution of the query in the service.  If</span>
        <span class="c1"># the request times out we keep trying. This situation is quite possible</span>
        <span class="c1"># if the query will return a large number of rows.</span>
        <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting on response from query: </span><span class="si">%s</span><span class="s1"> ...&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="c1"># We got some results. The last page is signalled by a missing pageToken.</span>
      <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">schema</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">pageToken</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="n">page_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">pageToken</span></div>

<div class="viewcode-block" id="BigQueryWrapper.insert_rows"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.insert_rows">[docs]</a>  <span class="k">def</span> <span class="nf">insert_rows</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">project_id</span><span class="p">,</span>
      <span class="n">dataset_id</span><span class="p">,</span>
      <span class="n">table_id</span><span class="p">,</span>
      <span class="n">rows</span><span class="p">,</span>
      <span class="n">insert_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
      <span class="n">ignore_unknown_values</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inserts rows into the specified table.</span>

<span class="sd">    Args:</span>
<span class="sd">      project_id: The project id owning the table.</span>
<span class="sd">      dataset_id: The dataset id owning the table.</span>
<span class="sd">      table_id: The table id.</span>
<span class="sd">      rows: A list of plain Python dictionaries. Each dictionary is a row and</span>
<span class="sd">        each key in it is the name of a field.</span>
<span class="sd">      skip_invalid_rows: If there are rows with insertion errors, whether they</span>
<span class="sd">        should be skipped, and all others should be inserted successfully.</span>
<span class="sd">      ignore_unknown_values: Set this option to true to ignore unknown column</span>
<span class="sd">        names. If the input rows contain columns that are not</span>
<span class="sd">        part of the existing table&#39;s schema, those columns are ignored, and</span>
<span class="sd">        the rows are successfully inserted.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple (bool, errors). If first element is False then the second element</span>
<span class="sd">      will be a bigquery.InsertErrorsValueListEntry instance containing</span>
<span class="sd">      specific errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Prepare rows for insertion. Of special note is the row ID that we add to</span>
    <span class="c1"># each row in order to help BigQuery avoid inserting a row multiple times.</span>
    <span class="c1"># BigQuery will do a best-effort if unique IDs are provided. This situation</span>
    <span class="c1"># can happen during retries on failures.</span>
    <span class="c1"># TODO(silviuc): Must add support to writing TableRow&#39;s instead of dicts.</span>
    <span class="n">insert_ids</span> <span class="o">=</span> <span class="p">[</span>
        <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_row_id</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">insert_ids</span> <span class="k">else</span> <span class="n">insert_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span>
        <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
    <span class="p">]</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">fast_json_loads</span><span class="p">(</span><span class="n">fast_json_dumps</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_encoder</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span>
    <span class="p">]</span>

    <span class="n">result</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_all_rows</span><span class="p">(</span>
        <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">insert_ids</span><span class="p">,</span>
        <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="n">skip_invalid_rows</span><span class="p">,</span>
        <span class="n">ignore_unknown_values</span><span class="o">=</span><span class="n">ignore_unknown_values</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">errors</span></div>

  <span class="k">def</span> <span class="nf">_convert_cell_value_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STRING&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;XYZ&quot; --&gt; Output: &quot;XYZ&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BOOLEAN&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;true&quot; --&gt; Output: True</span>
      <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;123&quot; --&gt; Output: 123</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;FLOAT&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;1.23&quot; --&gt; Output: 1.23</span>
      <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">:</span>
      <span class="c1"># The UTC should come from the timezone library but this is a known</span>
      <span class="c1"># issue in python 2.7 so we&#39;ll just hardcode it as we&#39;re reading using</span>
      <span class="c1"># utcfromtimestamp.</span>
      <span class="c1"># Input: 1478134176.985864 --&gt; Output: &quot;2016-11-03 00:49:36.985864 UTC&quot;</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1"> UTC&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BYTES&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;YmJi&quot; --&gt; Output: &quot;YmJi&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;2016-11-03&quot; --&gt; Output: &quot;2016-11-03&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;DATETIME&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;2016-11-03T00:49:36&quot; --&gt; Output: &quot;2016-11-03T00:49:36&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;00:49:36&quot; --&gt; Output: &quot;00:49:36&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RECORD&#39;</span><span class="p">:</span>
      <span class="c1"># Note that a schema field object supports also a RECORD type. However</span>
      <span class="c1"># when querying, the repeated and/or record fields are flattened</span>
      <span class="c1"># unless we pass the flatten_results flag as False to the source</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_row_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;GEOGRAPHY&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected field type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

<div class="viewcode-block" id="BigQueryWrapper.convert_row_to_dict"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWrapper.convert_row_to_dict">[docs]</a>  <span class="k">def</span> <span class="nf">convert_row_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a TableRow instance using the schema to a Python dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">from_json_value</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;v&#39;</span> <span class="ow">in</span> <span class="n">cell</span> <span class="k">else</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;REPEATED&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="c1"># Ideally this should never happen as repeated fields default to</span>
          <span class="c1"># returning an empty list</span>
          <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
              <span class="bp">self</span><span class="o">.</span><span class="n">_convert_cell_value_to_dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span>
          <span class="p">]</span>
      <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NULLABLE&#39;</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
              <span class="s1">&#39;Received </span><span class="se">\&#39;</span><span class="s1">None</span><span class="se">\&#39;</span><span class="s1"> as the value for the field </span><span class="si">%s</span><span class="s1"> &#39;</span>
              <span class="s1">&#39;but the field is not NULLABLE.&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_cell_value_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># BigQueryReader, BigQueryWriter.</span>


<div class="viewcode-block" id="BigQueryReader"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryReader">[docs]</a><span class="k">class</span> <span class="nc">BigQueryReader</span><span class="p">(</span><span class="n">dataflow_io</span><span class="o">.</span><span class="n">NativeSourceReader</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A reader for a BigQuery source.&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span>
      <span class="n">source</span><span class="p">,</span>
      <span class="n">test_bigquery_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">use_legacy_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">flatten_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
      <span class="n">kms_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
      <span class="n">query_priority</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span> <span class="o">=</span> <span class="n">test_bigquery_client</span>
    <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">is_running_in_gce</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">executing_project</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;pipeline_options&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">source</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">GoogleCloudOptions</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO(silviuc): Try to automatically get it from gcloud config info.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="ow">and</span> <span class="n">test_bigquery_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
          <span class="s1">&#39;Missing executing project information. Please use the --project &#39;</span>
          <span class="s1">&#39;command line option to specify it.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">coder</span><span class="p">,</span> <span class="n">RowAsDictJsonCoder</span><span class="p">)</span>
    <span class="c1"># Schema for the rows being read by the reader. It is initialized the</span>
    <span class="c1"># first time something gets read from the table. It is not required</span>
    <span class="c1"># for reading the field values in each row but could be useful for</span>
    <span class="c1"># getting additional details.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_legacy_sql</span> <span class="o">=</span> <span class="n">use_legacy_sql</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flatten_results</span> <span class="o">=</span> <span class="n">flatten_results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kms_key</span> <span class="o">=</span> <span class="n">kms_key</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bigquery_job_labels</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">bq_io_metadata</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="kn">from</span> <span class="nn">apache_beam.io.gcp.bigquery</span> <span class="kn">import</span> <span class="n">BigQueryQueryPriority</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">query_priority</span> <span class="o">=</span> <span class="n">query_priority</span> <span class="ow">or</span> <span class="n">BigQueryQueryPriority</span><span class="o">.</span><span class="n">BATCH</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># If table schema did not define a project we default to executing</span>
      <span class="c1"># project.</span>
      <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">project_id</span><span class="p">:</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM [</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">];&#39;</span> <span class="o">%</span> <span class="p">(</span>
          <span class="n">project_id</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Enforce the &quot;modes&quot; enforced by BigQuerySource.__init__.</span>
      <span class="c1"># If this exception has been raised, the BigQuerySource &quot;modes&quot; have</span>
      <span class="c1"># changed and this method will need to be updated as well.</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BigQuerySource must have either a table or query&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_source_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the source location (e.g. ``&quot;EU&quot;`` or ``&quot;US&quot;``) from either</span>

<span class="sd">    - :data:`source.table_reference`</span>
<span class="sd">      or</span>
<span class="sd">    - The first referenced table in :data:`source.query`</span>

<span class="sd">    See Also:</span>
<span class="sd">      - :meth:`BigQueryWrapper.get_query_location`</span>
<span class="sd">      - :meth:`BigQueryWrapper.get_table_location`</span>

<span class="sd">    Returns:</span>
<span class="sd">      Optional[str]: The source location, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_table_location</span><span class="p">(</span>
          <span class="n">tr</span><span class="o">.</span><span class="n">projectId</span> <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">projectId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span>
          <span class="n">tr</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span>
          <span class="n">tr</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># It&#39;s a query source</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_query_location</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">use_legacy_sql</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">BigQueryWrapper</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">is_user_configured_dataset</span><span class="p">():</span>
      <span class="c1"># Temp dataset was provided by the user so we do not have to create one.</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_temporary_dataset</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_source_location</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">clean_up_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">bq_io_metadata</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">bq_io_metadata</span> <span class="o">=</span> <span class="n">create_bigquery_io_metadata</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rows</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
        <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
        <span class="n">use_legacy_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_legacy_sql</span><span class="p">,</span>
        <span class="n">flatten_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_results</span><span class="p">,</span>
        <span class="n">priority</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query_priority</span><span class="p">,</span>
        <span class="n">job_labels</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bq_io_metadata</span><span class="o">.</span><span class="n">add_additional_bq_job_labels</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">bigquery_job_labels</span><span class="p">)):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="c1"># return base64 encoded bytes as byte type on python 3</span>
        <span class="c1"># which matches the behavior of Beam Java SDK</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BYTES&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">string_value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span><span class="p">:</span>
          <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">convert_row_to_dict</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">row</span></div>


<div class="viewcode-block" id="BigQueryWriter"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWriter">[docs]</a><span class="k">class</span> <span class="nc">BigQueryWriter</span><span class="p">(</span><span class="n">dataflow_io</span><span class="o">.</span><span class="n">NativeSinkWriter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The sink writer for a BigQuerySink.&quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">test_bigquery_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span> <span class="o">=</span> <span class="n">test_bigquery_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">coder</span><span class="p">,</span> <span class="n">RowAsDictJsonCoder</span><span class="p">)</span>
    <span class="c1"># Buffer used to batch written rows so we reduce communication with the</span>
    <span class="c1"># BigQuery service.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer_flush_threshold</span> <span class="o">=</span> <span class="n">buffer_size</span> <span class="ow">or</span> <span class="mi">1000</span>
    <span class="c1"># Figure out the project, dataset, and table used for the sink.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span>

    <span class="c1"># If table schema did not define a project we default to executing project.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s1">&#39;pipeline_options&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">sink</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">GoogleCloudOptions</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span>

  <span class="k">def</span> <span class="nf">_flush_rows_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">:</span>
      <span class="n">_LOGGER</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
          <span class="s1">&#39;Writing </span><span class="si">%d</span><span class="s1"> rows to </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> table.&#39;</span><span class="p">,</span>
          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">),</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">)</span>
      <span class="n">passed</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span>
          <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
          <span class="n">table_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">passed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Could not successfully insert rows to BigQuery&#39;</span>
            <span class="s1">&#39; table [</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">]. Errors: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span>

  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">BigQueryWrapper</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_or_create_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_schema</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">create_disposition</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">write_disposition</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_flush_rows_buffer</span><span class="p">()</span>

<div class="viewcode-block" id="BigQueryWriter.Write"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryWriter.Write">[docs]</a>  <span class="k">def</span> <span class="nf">Write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer_flush_threshold</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_flush_rows_buffer</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RowAsDictJsonCoder"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RowAsDictJsonCoder">[docs]</a><span class="k">class</span> <span class="nc">RowAsDictJsonCoder</span><span class="p">(</span><span class="n">coders</span><span class="o">.</span><span class="n">Coder</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A coder for a table row (represented as a dict) to/from a JSON string.</span>

<span class="sd">  This is the default coder for sources and sinks if the coder argument is not</span>
<span class="sd">  specified.</span>
<span class="sd">  &quot;&quot;&quot;</span>
<div class="viewcode-block" id="RowAsDictJsonCoder.encode"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RowAsDictJsonCoder.encode">[docs]</a>  <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_row</span><span class="p">):</span>
    <span class="c1"># The normal error when dumping NAN/INF values is:</span>
    <span class="c1"># ValueError: Out of range float values are not JSON compliant</span>
    <span class="c1"># This code will catch this error to emit an error that explains</span>
    <span class="c1"># to the programmer that they have used NAN/INF values.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
          <span class="n">table_row</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_encoder</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">. </span><span class="si">%s</span><span class="s1">. Row: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">JSON_COMPLIANCE_ERROR</span><span class="p">,</span> <span class="n">table_row</span><span class="p">))</span></div>

<div class="viewcode-block" id="RowAsDictJsonCoder.decode"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RowAsDictJsonCoder.decode">[docs]</a>  <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoded_table_row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">encoded_table_row</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="RowAsDictJsonCoder.to_type_hint"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RowAsDictJsonCoder.to_type_hint">[docs]</a>  <span class="k">def</span> <span class="nf">to_type_hint</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Any</span></div></div>


<div class="viewcode-block" id="JsonRowWriter"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter">[docs]</a><span class="k">class</span> <span class="nc">JsonRowWriter</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A writer which provides an IOBase-like interface for writing table rows</span>
<span class="sd">  (represented as dicts) as newline-delimited JSON strings.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_handle</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize an JsonRowWriter.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_handle (io.IOBase): Output stream to write to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Output stream must be writable&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span> <span class="o">=</span> <span class="n">file_handle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_coder</span> <span class="o">=</span> <span class="n">RowAsDictJsonCoder</span><span class="p">()</span>

<div class="viewcode-block" id="JsonRowWriter.close"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.close">[docs]</a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">closed</span>

<div class="viewcode-block" id="JsonRowWriter.flush"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.flush">[docs]</a>  <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="JsonRowWriter.read"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.read">[docs]</a>  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;JsonRowWriter is not readable&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="JsonRowWriter.tell"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.tell">[docs]</a>  <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span></div>

<div class="viewcode-block" id="JsonRowWriter.writable"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.writable">[docs]</a>  <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">writable</span><span class="p">()</span></div>

<div class="viewcode-block" id="JsonRowWriter.write"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.JsonRowWriter.write">[docs]</a>  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_coder</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="sa">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="AvroRowWriter"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter">[docs]</a><span class="k">class</span> <span class="nc">AvroRowWriter</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">IOBase</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  A writer which provides an IOBase-like interface for writing table rows</span>
<span class="sd">  (represented as dicts) as Avro records.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_handle</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Initialize an AvroRowWriter.</span>

<span class="sd">    Args:</span>
<span class="sd">      file_handle (io.IOBase): Output stream to write Avro records to.</span>
<span class="sd">      schema (Dict[Text, Any]): BigQuery table schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_handle</span><span class="o">.</span><span class="n">writable</span><span class="p">():</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Output stream must be writable&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span> <span class="o">=</span> <span class="n">file_handle</span>
    <span class="n">avro_schema</span> <span class="o">=</span> <span class="n">fastavro</span><span class="o">.</span><span class="n">parse_schema</span><span class="p">(</span>
        <span class="n">get_avro_schema_from_table_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_avro_writer</span> <span class="o">=</span> <span class="n">fastavro</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">Writer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="p">,</span> <span class="n">avro_schema</span><span class="p">)</span>

<div class="viewcode-block" id="AvroRowWriter.close"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.close">[docs]</a>  <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">closed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">closed</span>

<div class="viewcode-block" id="AvroRowWriter.flush"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.flush">[docs]</a>  <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;flush on closed file&quot;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_avro_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="AvroRowWriter.read"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.read">[docs]</a>  <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">size</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">io</span><span class="o">.</span><span class="n">UnsupportedOperation</span><span class="p">(</span><span class="s2">&quot;AvroRowWriter is not readable&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AvroRowWriter.tell"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.tell">[docs]</a>  <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Flush the fastavro Writer to the underlying stream, otherwise there isn&#39;t</span>
    <span class="c1"># a reliable way to determine how many bytes have been written.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_avro_writer</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span></div>

<div class="viewcode-block" id="AvroRowWriter.writable"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.writable">[docs]</a>  <span class="k">def</span> <span class="nf">writable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file_handle</span><span class="o">.</span><span class="n">writable</span><span class="p">()</span></div>

<div class="viewcode-block" id="AvroRowWriter.write"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AvroRowWriter.write">[docs]</a>  <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_avro_writer</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
      <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">tb</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
      <span class="k">raise</span> <span class="n">ex</span><span class="o">.</span><span class="vm">__class__</span><span class="p">(</span>
          <span class="s2">&quot;Error writing row to Avro: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Schema: </span><span class="si">{}</span><span class="se">\n</span><span class="s2">Row: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
              <span class="n">ex</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_avro_writer</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span><span class="o">.</span><span class="n">with_traceback</span><span class="p">(</span><span class="n">tb</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="RetryStrategy"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RetryStrategy">[docs]</a><span class="k">class</span> <span class="nc">RetryStrategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">RETRY_ALWAYS</span> <span class="o">=</span> <span class="s1">&#39;RETRY_ALWAYS&#39;</span>
  <span class="n">RETRY_NEVER</span> <span class="o">=</span> <span class="s1">&#39;RETRY_NEVER&#39;</span>
  <span class="n">RETRY_ON_TRANSIENT_ERROR</span> <span class="o">=</span> <span class="s1">&#39;RETRY_ON_TRANSIENT_ERROR&#39;</span>

  <span class="n">_NON_TRANSIENT_ERRORS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;invalidQuery&#39;</span><span class="p">,</span> <span class="s1">&#39;notImplemented&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="RetryStrategy.should_retry"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.RetryStrategy.should_retry">[docs]</a>  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">should_retry</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_ALWAYS</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_NEVER</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_ON_TRANSIENT_ERROR</span> <span class="ow">and</span>
          <span class="n">error_message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">_NON_TRANSIENT_ERRORS</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="AppendDestinationsFn"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AppendDestinationsFn">[docs]</a><span class="k">class</span> <span class="nc">AppendDestinationsFn</span><span class="p">(</span><span class="n">DoFn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Adds the destination to an element, making it a KV pair.</span>

<span class="sd">  Outputs a PCollection of KV-pairs where the key is a TableReference for the</span>
<span class="sd">  destination, and the value is the record itself.</span>

<span class="sd">  Experimental; no backwards compatibility guarantees.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_display_destination</span> <span class="o">=</span> <span class="n">destination</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">AppendDestinationsFn</span><span class="o">.</span><span class="n">_get_table_fn</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>

<div class="viewcode-block" id="AppendDestinationsFn.display_data"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AppendDestinationsFn.display_data">[docs]</a>  <span class="k">def</span> <span class="nf">display_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;destination&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_display_destination</span><span class="p">)}</span></div>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_value_provider_or_static_val</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">ValueProvider</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">elm</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># The type argument is a NoOp, because we assume the argument already has</span>
      <span class="c1"># the proper formatting.</span>
      <span class="k">return</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">StaticValueProvider</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">elm</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_get_table_fn</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">destination</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">AppendDestinationsFn</span><span class="o">.</span><span class="n">_value_provider_or_static_val</span><span class="p">(</span>
          <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<div class="viewcode-block" id="AppendDestinationsFn.process"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.AppendDestinationsFn.process">[docs]</a>  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">side_inputs</span><span class="p">):</span>
    <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">side_inputs</span><span class="p">),</span> <span class="n">element</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="get_table_schema_from_string"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.get_table_schema_from_string">[docs]</a><span class="k">def</span> <span class="nf">get_table_schema_from_string</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Transform the string table schema into a</span>
<span class="sd">  :class:`~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema` instance.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema (str): The sting schema to be used if the BigQuery table to write</span>
<span class="sd">      has to be created.</span>

<span class="sd">  Returns:</span>
<span class="sd">    ~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema:</span>
<span class="sd">    The schema to be used if the BigQuery table to write has to be created</span>
<span class="sd">    but in the :class:`~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema` format.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">table_schema</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">()</span>
  <span class="n">schema_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">schema</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)]</span>
  <span class="k">for</span> <span class="n">field_and_type</span> <span class="ow">in</span> <span class="n">schema_list</span><span class="p">:</span>
    <span class="n">field_name</span><span class="p">,</span> <span class="n">field_type</span> <span class="o">=</span> <span class="n">field_and_type</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)</span>
    <span class="n">field_schema</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">()</span>
    <span class="n">field_schema</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">field_name</span>
    <span class="n">field_schema</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">field_type</span>
    <span class="n">field_schema</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;NULLABLE&#39;</span>
    <span class="n">table_schema</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_schema</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">table_schema</span></div>


<div class="viewcode-block" id="table_schema_to_dict"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.table_schema_to_dict">[docs]</a><span class="k">def</span> <span class="nf">table_schema_to_dict</span><span class="p">(</span><span class="n">table_schema</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Create a dictionary representation of table schema for serialization</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">def</span> <span class="nf">get_table_field</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create a dictionary representation of a table field</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span>
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="s1">&#39;NULLABLE&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;description&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">description</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">description</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="s1">&#39;fields&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">field</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
      <span class="n">result</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">get_table_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">fields</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">result</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">):</span>
    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Table schema must be of the type bigquery.TableSchema&quot;</span><span class="p">)</span>
  <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fields&#39;</span><span class="p">:</span> <span class="p">[]}</span>
  <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">table_schema</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
    <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">get_table_field</span><span class="p">(</span><span class="n">field</span><span class="p">))</span>
  <span class="k">return</span> <span class="n">schema</span></div>


<div class="viewcode-block" id="get_dict_table_schema"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.get_dict_table_schema">[docs]</a><span class="k">def</span> <span class="nf">get_dict_table_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Transform the table schema into a dictionary instance.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema (str, dict, ~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema):</span>
<span class="sd">      The schema to be used if the BigQuery table to write has to be created.</span>
<span class="sd">      This can either be a dict or string or in the TableSchema format.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dict[str, Any]: The schema to be used if the BigQuery table to write has</span>
<span class="sd">    to be created but in the dictionary format.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">ValueProvider</span><span class="p">))</span> <span class="ow">or</span>
      <span class="n">callable</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span> <span class="ow">or</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">schema</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
    <span class="n">table_schema</span> <span class="o">=</span> <span class="n">get_table_schema_from_string</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table_schema_to_dict</span><span class="p">(</span><span class="n">table_schema</span><span class="p">)</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table_schema_to_dict</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Unexpected schema argument: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_avro_schema_from_table_schema"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.get_avro_schema_from_table_schema">[docs]</a><span class="k">def</span> <span class="nf">get_avro_schema_from_table_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Transform the table schema into an Avro schema.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema (str, dict, ~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema):</span>
<span class="sd">      The TableSchema to convert to Avro schema. This can either be a dict or</span>
<span class="sd">      string or in the TableSchema format.</span>

<span class="sd">  Returns:</span>
<span class="sd">    Dict[str, Any]: An Avro schema, which can be used by fastavro.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dict_table_schema</span> <span class="o">=</span> <span class="n">get_dict_table_schema</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">bigquery_avro_tools</span><span class="o">.</span><span class="n">get_record_schema_from_dict_table_schema</span><span class="p">(</span>
      <span class="s2">&quot;root&quot;</span><span class="p">,</span> <span class="n">dict_table_schema</span><span class="p">)</span></div>


<div class="viewcode-block" id="BigQueryJobTypes"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.BigQueryJobTypes">[docs]</a><span class="k">class</span> <span class="nc">BigQueryJobTypes</span><span class="p">:</span>
  <span class="n">EXPORT</span> <span class="o">=</span> <span class="s1">&#39;EXPORT&#39;</span>
  <span class="n">COPY</span> <span class="o">=</span> <span class="s1">&#39;COPY&#39;</span>
  <span class="n">LOAD</span> <span class="o">=</span> <span class="s1">&#39;LOAD&#39;</span>
  <span class="n">QUERY</span> <span class="o">=</span> <span class="s1">&#39;QUERY&#39;</span></div>


<div class="viewcode-block" id="generate_bq_job_name"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.generate_bq_job_name">[docs]</a><span class="k">def</span> <span class="nf">generate_bq_job_name</span><span class="p">(</span><span class="n">job_name</span><span class="p">,</span> <span class="n">step_id</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">random</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="kn">from</span> <span class="nn">apache_beam.io.gcp.bigquery</span> <span class="kn">import</span> <span class="n">BQ_JOB_NAME_TEMPLATE</span>
  <span class="n">random</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">random</span><span class="p">)</span> <span class="k">if</span> <span class="n">random</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
  <span class="k">return</span> <span class="nb">str</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
      <span class="n">BQ_JOB_NAME_TEMPLATE</span><span class="p">,</span>
      <span class="n">job_type</span><span class="o">=</span><span class="n">job_type</span><span class="p">,</span>
      <span class="n">job_id</span><span class="o">=</span><span class="n">job_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span>
      <span class="n">step_id</span><span class="o">=</span><span class="n">step_id</span><span class="p">,</span>
      <span class="n">random</span><span class="o">=</span><span class="n">random</span><span class="p">)</span></div>


<div class="viewcode-block" id="check_schema_equal"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery.check_schema_equal">[docs]</a><span class="k">def</span> <span class="nf">check_schema_equal</span><span class="p">(</span>
    <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ignore_descriptions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_field_order</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
  <span class="c1"># type: (Union[bigquery.TableSchema, bigquery.TableFieldSchema], Union[bigquery.TableSchema, bigquery.TableFieldSchema], bool, bool) -&gt; bool</span>

  <span class="sd">&quot;&quot;&quot;Check whether schemas are equivalent.</span>

<span class="sd">  This comparison function differs from using == to compare TableSchema</span>
<span class="sd">  because it ignores categories, policy tags, descriptions (optionally), and</span>
<span class="sd">  field ordering (optionally).</span>

<span class="sd">  Args:</span>
<span class="sd">    left (~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema, ~apache_beam.io.gcp.internal.clients.\</span>
<span class="sd">bigquery.bigquery_v2_messages.TableFieldSchema):</span>
<span class="sd">      One schema to compare.</span>
<span class="sd">    right (~apache_beam.io.gcp.internal.clients.bigquery.\</span>
<span class="sd">bigquery_v2_messages.TableSchema, ~apache_beam.io.gcp.internal.clients.\</span>
<span class="sd">bigquery.bigquery_v2_messages.TableFieldSchema):</span>
<span class="sd">      The other schema to compare.</span>
<span class="sd">    ignore_descriptions (bool): (optional) Whether or not to ignore field</span>
<span class="sd">      descriptions when comparing. Defaults to False.</span>
<span class="sd">    ignore_field_order (bool): (optional) Whether or not to ignore struct field</span>
<span class="sd">      order when comparing. Defaults to False.</span>

<span class="sd">  Returns:</span>
<span class="sd">    bool: True if the schemas are equivalent, False otherwise.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">left</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">type</span><span class="p">(</span><span class="n">right</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
      <span class="n">left</span><span class="p">,</span> <span class="p">(</span><span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">)):</span>
    <span class="k">return</span> <span class="kc">False</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
      <span class="c1"># Check for type aliases</span>
      <span class="k">if</span> <span class="nb">sorted</span><span class="p">(</span>
          <span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">right</span><span class="o">.</span><span class="n">type</span><span class="p">))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">([</span><span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;BOOLEAN&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;FLOAT&quot;</span><span class="p">,</span>
                                                                 <span class="s2">&quot;FLOAT64&quot;</span><span class="p">],</span>
                                           <span class="p">[</span><span class="s2">&quot;INT64&quot;</span><span class="p">,</span> <span class="s2">&quot;INTEGER&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;RECORD&quot;</span><span class="p">,</span>
                                                                  <span class="s2">&quot;STRUCT&quot;</span><span class="p">]):</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">left</span><span class="o">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_descriptions</span> <span class="ow">and</span> <span class="n">left</span><span class="o">.</span><span class="n">description</span> <span class="o">!=</span> <span class="n">right</span><span class="o">.</span><span class="n">description</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">left</span><span class="p">,</span>
                <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">)</span> <span class="ow">or</span> <span class="n">left</span><span class="o">.</span><span class="n">type</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;RECORD&quot;</span><span class="p">,</span> <span class="s2">&quot;STRUCT&quot;</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">fields</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">ignore_field_order</span><span class="p">:</span>
      <span class="n">left_fields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">left</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
      <span class="n">right_fields</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">right</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">field</span><span class="p">:</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">left_fields</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">fields</span>
      <span class="n">right_fields</span> <span class="o">=</span> <span class="n">right</span><span class="o">.</span><span class="n">fields</span>

    <span class="k">for</span> <span class="n">left_field</span><span class="p">,</span> <span class="n">right_field</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">left_fields</span><span class="p">,</span> <span class="n">right_fields</span><span class="p">):</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">check_schema_equal</span><span class="p">(</span><span class="n">left_field</span><span class="p">,</span>
                                <span class="n">right_field</span><span class="p">,</span>
                                <span class="n">ignore_descriptions</span><span class="o">=</span><span class="n">ignore_descriptions</span><span class="p">,</span>
                                <span class="n">ignore_field_order</span><span class="o">=</span><span class="n">ignore_field_order</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">False</span>

  <span class="k">return</span> <span class="kc">True</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>apache_beam.io.gcp.bigquery_tools &mdash; Apache Beam  documentation</title>
  

  
  
  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  

  

  
        <link rel="index" title="Index"
              href="../../../../genindex.html"/>
        <link rel="search" title="Search" href="../../../../search.html"/>
    <link rel="top" title="Apache Beam  documentation" href="../../../../index.html"/>
        <link rel="up" title="Module code" href="../../../index.html"/> 

  
  <script src="../../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../../index.html" class="icon icon-home"> Apache Beam
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.coders.html">apache_beam.coders package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.internal.html">apache_beam.internal package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.io.html">apache_beam.io package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.metrics.html">apache_beam.metrics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.options.html">apache_beam.options package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.portability.html">apache_beam.portability package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.runners.html">apache_beam.runners package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.testing.html">apache_beam.testing package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.tools.html">apache_beam.tools package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.transforms.html">apache_beam.transforms package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.typehints.html">apache_beam.typehints package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.utils.html">apache_beam.utils package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.error.html">apache_beam.error module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.pipeline.html">apache_beam.pipeline module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.pvalue.html">apache_beam.pvalue module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../apache_beam.version.html">apache_beam.version module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">Apache Beam</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../../index.html">Module code</a> &raquo;</li>
        
      <li>apache_beam.io.gcp.bigquery_tools</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for apache_beam.io.gcp.bigquery_tools</h1><div class="highlight"><pre>
<span></span><span class="c1">#</span>
<span class="c1"># Licensed to the Apache Software Foundation (ASF) under one or more</span>
<span class="c1"># contributor license agreements.  See the NOTICE file distributed with</span>
<span class="c1"># this work for additional information regarding copyright ownership.</span>
<span class="c1"># The ASF licenses this file to You under the Apache License, Version 2.0</span>
<span class="c1"># (the &quot;License&quot;); you may not use this file except in compliance with</span>
<span class="c1"># the License.  You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#    http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>
<span class="c1">#</span>

<span class="sd">&quot;&quot;&quot;Tools used by BigQuery sources and sinks.</span>

<span class="sd">Classes, constants and functions in this file are experimental and have no</span>
<span class="sd">backwards compatibility guarantees.</span>

<span class="sd">These tools include wrappers and clients to interact with BigQuery APIs.</span>

<span class="sd">NOTHING IN THIS FILE HAS BACKWARDS COMPATIBILITY GUARANTEES.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">absolute_import</span>

<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">decimal</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="kn">from</span> <span class="nn">future.utils</span> <span class="kn">import</span> <span class="n">iteritems</span>

<span class="kn">from</span> <span class="nn">apache_beam</span> <span class="kn">import</span> <span class="n">coders</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.gcp</span> <span class="kn">import</span> <span class="n">auth</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.gcp.json_value</span> <span class="kn">import</span> <span class="n">from_json_value</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.gcp.json_value</span> <span class="kn">import</span> <span class="n">to_json_value</span>
<span class="kn">from</span> <span class="nn">apache_beam.internal.http_client</span> <span class="kn">import</span> <span class="n">get_new_http</span>
<span class="kn">from</span> <span class="nn">apache_beam.io.gcp.internal.clients</span> <span class="kn">import</span> <span class="n">bigquery</span>
<span class="kn">from</span> <span class="nn">apache_beam.options</span> <span class="kn">import</span> <span class="n">value_provider</span>
<span class="kn">from</span> <span class="nn">apache_beam.options.pipeline_options</span> <span class="kn">import</span> <span class="n">GoogleCloudOptions</span>
<span class="kn">from</span> <span class="nn">apache_beam.runners.dataflow.native_io</span> <span class="kn">import</span> <span class="n">iobase</span> <span class="k">as</span> <span class="n">dataflow_io</span>
<span class="kn">from</span> <span class="nn">apache_beam.transforms</span> <span class="kn">import</span> <span class="n">DoFn</span>
<span class="kn">from</span> <span class="nn">apache_beam.utils</span> <span class="kn">import</span> <span class="n">retry</span>

<span class="c1"># Protect against environments where bigquery library is not available.</span>
<span class="c1"># pylint: disable=wrong-import-order, wrong-import-position</span>
<span class="k">try</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">apitools.base.py.exceptions</span> <span class="kn">import</span> <span class="n">HttpError</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
  <span class="k">pass</span>


<span class="c1"># pylint: enable=wrong-import-order, wrong-import-position</span>


<span class="n">MAX_RETRIES</span> <span class="o">=</span> <span class="mi">3</span>


<span class="n">JSON_COMPLIANCE_ERROR</span> <span class="o">=</span> <span class="s1">&#39;NAN, INF and -INF values are not JSON compliant.&#39;</span>


<div class="viewcode-block" id="default_encoder"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.default_encoder">[docs]</a><span class="k">def</span> <span class="nf">default_encoder</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
      <span class="s2">&quot;Object of type &#39;</span><span class="si">%s</span><span class="s2">&#39; is not JSON serializable&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_hashable_destination"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.get_hashable_destination">[docs]</a><span class="k">def</span> <span class="nf">get_hashable_destination</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parses a table reference into a (project, dataset, table) tuple.</span>

<span class="sd">  Args:</span>
<span class="sd">    destination: Either a TableReference object from the bigquery API.</span>
<span class="sd">      The object has the following attributes: projectId, datasetId, and</span>
<span class="sd">      tableId. Or a string representing the destination containing</span>
<span class="sd">      &#39;PROJECT:DATASET.TABLE&#39;.</span>
<span class="sd">  Returns:</span>
<span class="sd">    A string representing the destination containing</span>
<span class="sd">    &#39;PROJECT:DATASET.TABLE&#39;.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableReference</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">destination</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="n">destination</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">destination</span></div>


<div class="viewcode-block" id="parse_table_schema_from_json"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.parse_table_schema_from_json">[docs]</a><span class="k">def</span> <span class="nf">parse_table_schema_from_json</span><span class="p">(</span><span class="n">schema_string</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parse the Table Schema provided as string.</span>

<span class="sd">  Args:</span>
<span class="sd">    schema_string: String serialized table schema, should be a valid JSON.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A TableSchema of the BigQuery export from either the Query or the Table.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">json_schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">schema_string</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_parse_schema_field</span><span class="p">(</span><span class="n">field</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse a single schema field from dictionary.</span>

<span class="sd">    Args:</span>
<span class="sd">      field: Dictionary object containing serialized schema.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A TableFieldSchema for a single column in BigQuery.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">()</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
    <span class="n">schema</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;mode&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;mode&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s1">&#39;NULLABLE&#39;</span>
    <span class="k">if</span> <span class="s1">&#39;description&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;description&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="s1">&#39;fields&#39;</span> <span class="ow">in</span> <span class="n">field</span><span class="p">:</span>
      <span class="n">schema</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_schema_field</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">field</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]]</span>
    <span class="k">return</span> <span class="n">schema</span>

  <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span><span class="n">_parse_schema_field</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">json_schema</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">]]</span>
  <span class="k">return</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_table_reference"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.parse_table_reference">[docs]</a><span class="k">def</span> <span class="nf">parse_table_reference</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">project</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Parses a table reference into a (project, dataset, table) tuple.</span>

<span class="sd">  Args:</span>
<span class="sd">    table: The ID of the table. The ID must contain only letters</span>
<span class="sd">      (a-z, A-Z), numbers (0-9), or underscores (_). If dataset argument is None</span>
<span class="sd">      then the table argument must contain the entire table reference:</span>
<span class="sd">      &#39;DATASET.TABLE&#39; or &#39;PROJECT:DATASET.TABLE&#39;. This argument can be a</span>
<span class="sd">      bigquery.TableReference instance in which case dataset and project are</span>
<span class="sd">      ignored and the reference is returned as a result.  Additionally, for date</span>
<span class="sd">      partitioned tables, appending &#39;$YYYYmmdd&#39; to the table name is supported,</span>
<span class="sd">      e.g. &#39;DATASET.TABLE$YYYYmmdd&#39;.</span>
<span class="sd">    dataset: The ID of the dataset containing this table or null if the table</span>
<span class="sd">      reference is specified entirely by the table argument.</span>
<span class="sd">    project: The ID of the project containing this table or null if the table</span>
<span class="sd">      reference is specified entirely by the table (and possibly dataset)</span>
<span class="sd">      argument.</span>

<span class="sd">  Returns:</span>
<span class="sd">    A TableReference object from the bigquery API. The object has the following</span>
<span class="sd">    attributes: projectId, datasetId, and tableId.</span>

<span class="sd">  Raises:</span>
<span class="sd">    ValueError: if the table reference as a string does not match the expected</span>
<span class="sd">      format.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableReference</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table</span>
  <span class="k">elif</span> <span class="n">callable</span><span class="p">(</span><span class="n">table</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table</span>
  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">ValueProvider</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">table</span>

  <span class="n">table_reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableReference</span><span class="p">()</span>
  <span class="c1"># If dataset argument is not specified, the expectation is that the</span>
  <span class="c1"># table argument will contain a full table reference instead of just a</span>
  <span class="c1"># table name.</span>
  <span class="k">if</span> <span class="n">dataset</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">match</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span>
        <span class="sa">r</span><span class="s1">&#39;^((?P&lt;project&gt;.+):)?(?P&lt;dataset&gt;\w+)\.(?P&lt;table&gt;[\w\$]+)$&#39;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
          <span class="s1">&#39;Expected a table reference (PROJECT:DATASET.TABLE or &#39;</span>
          <span class="s1">&#39;DATASET.TABLE) instead of </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">table</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;project&#39;</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;dataset&#39;</span><span class="p">)</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s1">&#39;table&#39;</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span> <span class="o">=</span> <span class="n">dataset</span>
    <span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span> <span class="o">=</span> <span class="n">table</span>
  <span class="k">return</span> <span class="n">table_reference</span></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># BigQueryWrapper.</span>


<div class="viewcode-block" id="BigQueryWrapper"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper">[docs]</a><span class="k">class</span> <span class="nc">BigQueryWrapper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;BigQuery client wrapper with utilities for querying.</span>

<span class="sd">  The wrapper is used to organize all the BigQuery integration points and</span>
<span class="sd">  offer a common place where retry logic for failures can be controlled.</span>
<span class="sd">  In addition it offers various functions used both in sources and sinks</span>
<span class="sd">  (e.g., find and create tables, query a table, etc.).</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="n">TEMP_TABLE</span> <span class="o">=</span> <span class="s1">&#39;temp_table_&#39;</span>
  <span class="n">TEMP_DATASET</span> <span class="o">=</span> <span class="s1">&#39;temp_dataset_&#39;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">client</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span> <span class="ow">or</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryV2</span><span class="p">(</span>
        <span class="n">http</span><span class="o">=</span><span class="n">get_new_http</span><span class="p">(),</span>
        <span class="n">credentials</span><span class="o">=</span><span class="n">auth</span><span class="o">.</span><span class="n">get_service_credentials</span><span class="p">(),</span>
        <span class="n">response_encoding</span><span class="o">=</span><span class="kc">None</span> <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="k">else</span> <span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># For testing scenarios where we pass in a client we do not want a</span>
    <span class="c1"># randomized prefix for row IDs.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_row_id_prefix</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span> <span class="k">if</span> <span class="n">client</span> <span class="k">else</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span> <span class="o">=</span> <span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span>

  <span class="nd">@property</span>
  <span class="k">def</span> <span class="nf">unique_row_id</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns a unique row ID (str) used to avoid multiple insertions.</span>

<span class="sd">    If the row ID is provided, BigQuery will make a best effort to not insert</span>
<span class="sd">    the same row multiple times for fail and retry scenarios in which the insert</span>
<span class="sd">    request may be issued several times. This comes into play for sinks executed</span>
<span class="sd">    in a local runner.</span>

<span class="sd">    Returns:</span>
<span class="sd">      a unique row ID string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_row_id_prefix</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unique_row_id</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_temp_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">parse_table_reference</span><span class="p">(</span>
        <span class="n">table</span><span class="o">=</span><span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">TEMP_TABLE</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span><span class="p">,</span>
        <span class="n">dataset</span><span class="o">=</span><span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">TEMP_DATASET</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span><span class="p">,</span>
        <span class="n">project</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>

<div class="viewcode-block" id="BigQueryWrapper.get_query_location"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_query_location">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_query_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">use_legacy_sql</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the location of tables referenced in a query.</span>

<span class="sd">    This method returns the location of the first referenced table in the query</span>
<span class="sd">    and depends on the BigQuery service to provide error handling for</span>
<span class="sd">    queries that reference tables in multiple locations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
                                      <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">dryRun</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationQuery</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">useLegacySql</span><span class="o">=</span><span class="n">use_legacy_sql</span><span class="p">,</span>
                <span class="p">)),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">statistics</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># This behavior is only expected in tests</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
          <span class="s2">&quot;Unable to get location, missing response.statistics. Query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
          <span class="n">query</span><span class="p">)</span>
      <span class="k">return</span> <span class="kc">None</span>

    <span class="n">referenced_tables</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">statistics</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">referencedTables</span>
    <span class="k">if</span> <span class="n">referenced_tables</span><span class="p">:</span>  <span class="c1"># Guards against both non-empty and non-None</span>
      <span class="n">table</span> <span class="o">=</span> <span class="n">referenced_tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table_location</span><span class="p">(</span>
          <span class="n">table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span>
          <span class="n">table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span>
          <span class="n">table</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using location </span><span class="si">%r</span><span class="s2"> from table </span><span class="si">%r</span><span class="s2"> referenced by query </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                   <span class="n">location</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">location</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query </span><span class="si">%s</span><span class="s2"> does not reference any tables.&quot;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_copy_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">project_id</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">,</span>
                       <span class="n">from_table_reference</span><span class="p">,</span>
                       <span class="n">to_table_reference</span><span class="p">,</span>
                       <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">()</span>
    <span class="n">reference</span><span class="o">.</span><span class="n">jobId</span> <span class="o">=</span> <span class="n">job_id</span>
    <span class="n">reference</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project_id</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">copy</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationTableCopy</span><span class="p">(</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="n">to_table_reference</span><span class="p">,</span>
                    <span class="n">sourceTable</span><span class="o">=</span><span class="n">from_table_reference</span><span class="p">,</span>
                    <span class="n">createDisposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
                    <span class="n">writeDisposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Inserting job request: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Response was </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_load_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">project_id</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">,</span>
                       <span class="n">table_reference</span><span class="p">,</span>
                       <span class="n">source_uris</span><span class="p">,</span>
                       <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">additional_load_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">additional_load_parameters</span> <span class="o">=</span> <span class="n">additional_load_parameters</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">job_schema</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">schema</span> <span class="o">==</span> <span class="s1">&#39;SCHEMA_AUTODETECT&#39;</span> <span class="k">else</span> <span class="n">schema</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">load</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationLoad</span><span class="p">(</span>
                    <span class="n">sourceUris</span><span class="o">=</span><span class="n">source_uris</span><span class="p">,</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="n">table_reference</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="n">job_schema</span><span class="p">,</span>
                    <span class="n">writeDisposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
                    <span class="n">createDisposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
                    <span class="n">sourceFormat</span><span class="o">=</span><span class="s1">&#39;NEWLINE_DELIMITED_JSON&#39;</span><span class="p">,</span>
                    <span class="n">autodetect</span><span class="o">=</span><span class="n">schema</span> <span class="o">==</span> <span class="s1">&#39;SCHEMA_AUTODETECT&#39;</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">additional_load_parameters</span>
                <span class="p">)</span>
            <span class="p">),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_start_query_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">use_legacy_sql</span><span class="p">,</span> <span class="n">flatten_results</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">,</span> <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JobReference</span><span class="p">(</span><span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">job</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">Job</span><span class="p">(</span>
            <span class="n">configuration</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfiguration</span><span class="p">(</span>
                <span class="n">dryRun</span><span class="o">=</span><span class="n">dry_run</span><span class="p">,</span>
                <span class="n">query</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">JobConfigurationQuery</span><span class="p">(</span>
                    <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                    <span class="n">useLegacySql</span><span class="o">=</span><span class="n">use_legacy_sql</span><span class="p">,</span>
                    <span class="n">allowLargeResults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">destinationTable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">),</span>
                    <span class="n">flattenResults</span><span class="o">=</span><span class="n">flatten_results</span><span class="p">)),</span>
            <span class="n">jobReference</span><span class="o">=</span><span class="n">reference</span><span class="p">))</span>

    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">jobId</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">jobReference</span><span class="o">.</span><span class="n">location</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_get_query_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span>
                         <span class="n">page_token</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">max_results</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsGetQueryResultsRequest</span><span class="p">(</span>
        <span class="n">jobId</span><span class="o">=</span><span class="n">job_id</span><span class="p">,</span> <span class="n">pageToken</span><span class="o">=</span><span class="n">page_token</span><span class="p">,</span> <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
        <span class="n">maxResults</span><span class="o">=</span><span class="n">max_results</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">GetQueryResults</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_timeout_or_quota_issues_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_insert_all_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span>
                       <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Calls the insertAll BigQuery API endpoint.</span>

<span class="sd">    Docs for this BQ call: https://cloud.google.com/bigquery/docs/reference\</span>
<span class="sd">      /rest/v2/tabledata/insertAll.&quot;&quot;&quot;</span>
    <span class="c1"># The rows argument is a list of</span>
    <span class="c1"># bigquery.TableDataInsertAllRequest.RowsValueListEntry instances as</span>
    <span class="c1"># required by the InsertAll() method.</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTabledataInsertAllRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
        <span class="n">tableDataInsertAllRequest</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">TableDataInsertAllRequest</span><span class="p">(</span>
            <span class="n">skipInvalidRows</span><span class="o">=</span><span class="n">skip_invalid_rows</span><span class="p">,</span>
            <span class="c1"># TODO(silviuc): Should have an option for ignoreUnknownValues?</span>
            <span class="n">rows</span><span class="o">=</span><span class="n">rows</span><span class="p">))</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tabledata</span><span class="o">.</span><span class="n">InsertAll</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># response.insertErrors is not [] if errors encountered.</span>
    <span class="k">return</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">insertErrors</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">insertErrors</span>

<div class="viewcode-block" id="BigQueryWrapper.get_table"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_table">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lookup a table&#39;s metadata object.</span>

<span class="sd">    Args:</span>
<span class="sd">      client: bigquery.BigqueryV2 instance</span>
<span class="sd">      project_id: table lookup parameter</span>
<span class="sd">      dataset_id: table lookup parameter</span>
<span class="sd">      table_id: table lookup parameter</span>

<span class="sd">    Returns:</span>
<span class="sd">      bigquery.Table instance</span>
<span class="sd">    Raises:</span>
<span class="sd">      HttpError if lookup failed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesGetRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span></div>

  <span class="k">def</span> <span class="nf">_create_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">project_id</span><span class="p">,</span>
                    <span class="n">dataset_id</span><span class="p">,</span>
                    <span class="n">table_id</span><span class="p">,</span>
                    <span class="n">schema</span><span class="p">,</span>
                    <span class="n">additional_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">additional_parameters</span> <span class="o">=</span> <span class="n">additional_parameters</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>
        <span class="n">tableReference</span><span class="o">=</span><span class="n">bigquery</span><span class="o">.</span><span class="n">TableReference</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">),</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
        <span class="o">**</span><span class="n">additional_parameters</span><span class="p">)</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesInsertRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="n">table</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Created the table with id </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="c1"># The response is a bigquery.Table instance.</span>
    <span class="k">return</span> <span class="n">response</span>

<div class="viewcode-block" id="BigQueryWrapper.get_or_create_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_or_create_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_or_create_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Check if dataset already exists otherwise create it</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">dataset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
          <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">dataset</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">dataset_reference</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">DatasetReference</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">datasetReference</span><span class="o">=</span><span class="n">dataset_reference</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
          <span class="n">dataset</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>
        <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsInsertRequest</span><span class="p">(</span>
            <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset</span><span class="o">=</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Insert</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
        <span class="c1"># The response is a bigquery.Dataset instance.</span>
        <span class="k">return</span> <span class="n">response</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span></div>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_is_table_empty</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTabledataListRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
        <span class="n">maxResults</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tabledata</span><span class="o">.</span><span class="n">List</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="c1"># The response is a bigquery.TableDataList instance.</span>
    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">totalRows</span> <span class="o">==</span> <span class="mi">0</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_delete_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryTablesDeleteRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span> <span class="n">tableId</span><span class="o">=</span><span class="n">table_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span>
                        <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">_delete_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">delete_contents</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsDeleteRequest</span><span class="p">(</span>
        <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
        <span class="n">deleteContents</span><span class="o">=</span><span class="n">delete_contents</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Delete</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span>
                        <span class="n">dataset_id</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

<div class="viewcode-block" id="BigQueryWrapper.get_table_location"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_table_location">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_table_location</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">):</span>
    <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">location</span></div>

<div class="viewcode-block" id="BigQueryWrapper.create_temporary_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.create_temporary_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">create_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">location</span><span class="p">):</span>
    <span class="n">dataset_id</span> <span class="o">=</span> <span class="n">BigQueryWrapper</span><span class="o">.</span><span class="n">TEMP_DATASET</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temporary_table_suffix</span>
    <span class="c1"># Check if dataset exists to make sure that the temporary id is unique</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
          <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">))</span>
      <span class="k">if</span> <span class="n">project_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Unittests don&#39;t pass projectIds so they can be run without error</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> already exists so cannot be used as temporary.&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist so we will create it as temporary &#39;</span>
            <span class="s1">&#39;with location=</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_or_create_dataset</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span></div>

<div class="viewcode-block" id="BigQueryWrapper.clean_up_temporary_dataset"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.clean_up_temporary_dataset">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">clean_up_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">):</span>
    <span class="n">temp_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_temp_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryDatasetsGetRequest</span><span class="p">(</span>
          <span class="n">projectId</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span> <span class="n">datasetId</span><span class="o">=</span><span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">))</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Dataset </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> does not exist&#39;</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span>
                        <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">)</span>
        <span class="k">return</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_delete_dataset</span><span class="p">(</span><span class="n">temp_table</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">temp_table</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="BigQueryWrapper.get_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_job">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">request</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">BigqueryJobsGetRequest</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">jobId</span> <span class="o">=</span> <span class="n">job_id</span>
    <span class="n">request</span><span class="o">.</span><span class="n">projectId</span> <span class="o">=</span> <span class="n">project</span>
    <span class="n">request</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">location</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">Get</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="BigQueryWrapper.perform_load_job"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.perform_load_job">[docs]</a>  <span class="k">def</span> <span class="nf">perform_load_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">destination</span><span class="p">,</span>
                       <span class="n">files</span><span class="p">,</span>
                       <span class="n">job_id</span><span class="p">,</span>
                       <span class="n">schema</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">write_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">create_disposition</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">additional_load_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts a job to load data into BigQuery.</span>

<span class="sd">    Returns:</span>
<span class="sd">      bigquery.JobReference with the information about the job that was started.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_load_job</span><span class="p">(</span>
        <span class="n">destination</span><span class="o">.</span><span class="n">projectId</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">destination</span><span class="p">,</span> <span class="n">files</span><span class="p">,</span>
        <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
        <span class="n">create_disposition</span><span class="o">=</span><span class="n">create_disposition</span><span class="p">,</span>
        <span class="n">write_disposition</span><span class="o">=</span><span class="n">write_disposition</span><span class="p">,</span>
        <span class="n">additional_load_parameters</span><span class="o">=</span><span class="n">additional_load_parameters</span><span class="p">)</span></div>

<div class="viewcode-block" id="BigQueryWrapper.get_or_create_table"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.get_or_create_table">[docs]</a>  <span class="nd">@retry</span><span class="o">.</span><span class="n">with_exponential_backoff</span><span class="p">(</span>
      <span class="n">num_retries</span><span class="o">=</span><span class="n">MAX_RETRIES</span><span class="p">,</span>
      <span class="n">retry_filter</span><span class="o">=</span><span class="n">retry</span><span class="o">.</span><span class="n">retry_on_server_errors_and_timeout_filter</span><span class="p">)</span>
  <span class="k">def</span> <span class="nf">get_or_create_table</span><span class="p">(</span>
      <span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span>
      <span class="n">create_disposition</span><span class="p">,</span> <span class="n">write_disposition</span><span class="p">,</span> <span class="n">additional_create_parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gets or creates a table based on create and write dispositions.</span>

<span class="sd">    The function mimics the behavior of BigQuery import jobs when using the</span>
<span class="sd">    same create and write dispositions.</span>

<span class="sd">    Args:</span>
<span class="sd">      project_id: The project id owning the table.</span>
<span class="sd">      dataset_id: The dataset id owning the table.</span>
<span class="sd">      table_id: The table id.</span>
<span class="sd">      schema: A bigquery.TableSchema instance or None.</span>
<span class="sd">      create_disposition: CREATE_NEVER or CREATE_IF_NEEDED.</span>
<span class="sd">      write_disposition: WRITE_APPEND, WRITE_EMPTY or WRITE_TRUNCATE.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A bigquery.Table instance if table was found or created.</span>

<span class="sd">    Raises:</span>
<span class="sd">      `RuntimeError`: For various mismatches between the state of the table and</span>
<span class="sd">        the create/write dispositions passed in. For example if the table is not</span>
<span class="sd">        empty and WRITE_EMPTY was specified then an error will be raised since</span>
<span class="sd">        the table was expected to be empty.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">apache_beam.io.gcp.bigquery</span> <span class="kn">import</span> <span class="n">BigQueryDisposition</span>

    <span class="n">found_table</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">found_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">404</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">create_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">CREATE_NEVER</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
              <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> not found but create disposition is CREATE_NEVER.&#39;</span>
              <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="c1"># If table exists already then handle the semantics for WRITE_EMPTY and</span>
    <span class="c1"># WRITE_TRUNCATE write dispositions.</span>
    <span class="k">if</span> <span class="n">found_table</span><span class="p">:</span>
      <span class="n">table_empty</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_table_empty</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">table_empty</span> <span class="ow">and</span>
          <span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_EMPTY</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> is not empty but write disposition is WRITE_EMPTY.&#39;</span>
            <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
      <span class="c1"># Delete the table and recreate it (later) if WRITE_TRUNCATE was</span>
      <span class="c1"># specified.</span>
      <span class="k">if</span> <span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>

    <span class="c1"># Create a new table potentially reusing the schema from a previously</span>
    <span class="c1"># found table in case the schema was not specified.</span>
    <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">found_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
          <span class="s1">&#39;Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> requires a schema. None can be inferred because the &#39;</span>
          <span class="s1">&#39;table does not exist.&#39;</span>
          <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">found_table</span> <span class="ow">and</span> <span class="n">write_disposition</span> <span class="o">!=</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">found_table</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">created_table</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">created_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_table</span><span class="p">(</span>
            <span class="n">project_id</span><span class="o">=</span><span class="n">project_id</span><span class="p">,</span>
            <span class="n">dataset_id</span><span class="o">=</span><span class="n">dataset_id</span><span class="p">,</span>
            <span class="n">table_id</span><span class="o">=</span><span class="n">table_id</span><span class="p">,</span>
            <span class="n">schema</span><span class="o">=</span><span class="n">schema</span> <span class="ow">or</span> <span class="n">found_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
            <span class="n">additional_parameters</span><span class="o">=</span><span class="n">additional_create_parameters</span><span class="p">)</span>
      <span class="k">except</span> <span class="n">HttpError</span> <span class="k">as</span> <span class="n">exn</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">exn</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">409</span><span class="p">:</span>
          <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Skipping Creation. Table </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> already exists.&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">))</span>
          <span class="n">created_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_table</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">raise</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Created table </span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> with schema </span><span class="si">%s</span><span class="s1">. &#39;</span>
                   <span class="s1">&#39;Result: </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span>
                   <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span>
                   <span class="n">schema</span> <span class="ow">or</span> <span class="n">found_table</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
                   <span class="n">created_table</span><span class="p">)</span>
      <span class="c1"># if write_disposition == BigQueryDisposition.WRITE_TRUNCATE we delete</span>
      <span class="c1"># the table before this point.</span>
      <span class="k">if</span> <span class="n">write_disposition</span> <span class="o">==</span> <span class="n">BigQueryDisposition</span><span class="o">.</span><span class="n">WRITE_TRUNCATE</span><span class="p">:</span>
        <span class="c1"># BigQuery can route data to the old table for 2 mins max so wait</span>
        <span class="c1"># that much time before creating the table and writing it</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Sleeping for 150 seconds before the write as &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;BigQuery inserts can be routed to deleted table &#39;</span> <span class="o">+</span>
                        <span class="s1">&#39;for 2 mins after the delete and create.&#39;</span><span class="p">)</span>
        <span class="c1"># TODO(BEAM-2673): Remove this sleep by migrating to load api</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">150</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">created_table</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">created_table</span></div>

<div class="viewcode-block" id="BigQueryWrapper.run_query"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.run_query">[docs]</a>  <span class="k">def</span> <span class="nf">run_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">use_legacy_sql</span><span class="p">,</span> <span class="n">flatten_results</span><span class="p">,</span>
                <span class="n">dry_run</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">job_id</span><span class="p">,</span> <span class="n">location</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_query_job</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span>
                                             <span class="n">use_legacy_sql</span><span class="p">,</span> <span class="n">flatten_results</span><span class="p">,</span>
                                             <span class="n">job_id</span><span class="o">=</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()</span><span class="o">.</span><span class="n">hex</span><span class="p">,</span>
                                             <span class="n">dry_run</span><span class="o">=</span><span class="n">dry_run</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">dry_run</span><span class="p">:</span>
      <span class="c1"># If this was a dry run then the fact that we get here means the</span>
      <span class="c1"># query has no errors. The start_query_job would raise an error otherwise.</span>
      <span class="k">return</span>
    <span class="n">page_token</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
      <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_query_results</span><span class="p">(</span><span class="n">project_id</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span>
                                         <span class="n">page_token</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="n">location</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">jobComplete</span><span class="p">:</span>
        <span class="c1"># The jobComplete field can be False if the query request times out</span>
        <span class="c1"># (default is 10 seconds). Note that this is a timeout for the query</span>
        <span class="c1"># request not for the actual execution of the query in the service.  If</span>
        <span class="c1"># the request times out we keep trying. This situation is quite possible</span>
        <span class="c1"># if the query will return a large number of rows.</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Waiting on response from query: </span><span class="si">%s</span><span class="s1"> ...&#39;</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
        <span class="k">continue</span>
      <span class="c1"># We got some results. The last page is signalled by a missing pageToken.</span>
      <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">schema</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">response</span><span class="o">.</span><span class="n">pageToken</span><span class="p">:</span>
        <span class="k">break</span>
      <span class="n">page_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">pageToken</span></div>

<div class="viewcode-block" id="BigQueryWrapper.insert_rows"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.insert_rows">[docs]</a>  <span class="k">def</span> <span class="nf">insert_rows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">insert_ids</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                  <span class="n">skip_invalid_rows</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inserts rows into the specified table.</span>

<span class="sd">    Args:</span>
<span class="sd">      project_id: The project id owning the table.</span>
<span class="sd">      dataset_id: The dataset id owning the table.</span>
<span class="sd">      table_id: The table id.</span>
<span class="sd">      rows: A list of plain Python dictionaries. Each dictionary is a row and</span>
<span class="sd">        each key in it is the name of a field.</span>
<span class="sd">      skip_invalid_rows: If there are rows with insertion errors, whether they</span>
<span class="sd">        should be skipped, and all others should be inserted successfully.</span>

<span class="sd">    Returns:</span>
<span class="sd">      A tuple (bool, errors). If first element is False then the second element</span>
<span class="sd">      will be a bigquery.InserttErrorsValueListEntry instance containing</span>
<span class="sd">      specific errors.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Prepare rows for insertion. Of special note is the row ID that we add to</span>
    <span class="c1"># each row in order to help BigQuery avoid inserting a row multiple times.</span>
    <span class="c1"># BigQuery will do a best-effort if unique IDs are provided. This situation</span>
    <span class="c1"># can happen during retries on failures.</span>
    <span class="c1"># TODO(silviuc): Must add support to writing TableRow&#39;s instead of dicts.</span>
    <span class="n">final_rows</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">rows</span><span class="p">):</span>
      <span class="n">json_row</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_to_json_row</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
      <span class="n">insert_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique_row_id</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">insert_ids</span> <span class="k">else</span> <span class="n">insert_ids</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">final_rows</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bigquery</span><span class="o">.</span><span class="n">TableDataInsertAllRequest</span><span class="o">.</span><span class="n">RowsValueListEntry</span><span class="p">(</span>
          <span class="n">insertId</span><span class="o">=</span><span class="n">insert_id</span><span class="p">,</span> <span class="n">json</span><span class="o">=</span><span class="n">json_row</span><span class="p">))</span>
    <span class="n">result</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_insert_all_rows</span><span class="p">(</span>
        <span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="p">,</span> <span class="n">table_id</span><span class="p">,</span> <span class="n">final_rows</span><span class="p">,</span> <span class="n">skip_invalid_rows</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">errors</span></div>

  <span class="k">def</span> <span class="nf">_convert_to_json_row</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="n">json_object</span> <span class="o">=</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">JsonObject</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">):</span>
        <span class="c1"># decimal values are converted into string because JSON does not</span>
        <span class="c1"># support the precision that decimal supports. BQ is able to handle</span>
        <span class="c1"># inserts into NUMERIC columns by receiving JSON with string attrs.</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
      <span class="n">json_object</span><span class="o">.</span><span class="n">additionalProperties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
          <span class="n">bigquery</span><span class="o">.</span><span class="n">JsonObject</span><span class="o">.</span><span class="n">AdditionalProperty</span><span class="p">(</span>
              <span class="n">key</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">to_json_value</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">json_object</span>

  <span class="k">def</span> <span class="nf">_convert_cell_value_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;STRING&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;XYZ&quot; --&gt; Output: &quot;XYZ&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BOOLEAN&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;true&quot; --&gt; Output: True</span>
      <span class="k">return</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;INTEGER&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;123&quot; --&gt; Output: 123</span>
      <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;FLOAT&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;1.23&quot; --&gt; Output: 1.23</span>
      <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TIMESTAMP&#39;</span><span class="p">:</span>
      <span class="c1"># The UTC should come from the timezone library but this is a known</span>
      <span class="c1"># issue in python 2.7 so we&#39;ll just hardcode it as we&#39;re reading using</span>
      <span class="c1"># utcfromtimestamp.</span>
      <span class="c1"># Input: 1478134176.985864 --&gt; Output: &quot;2016-11-03 00:49:36.985864 UTC&quot;</span>
      <span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S.</span><span class="si">%f</span><span class="s1"> UTC&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BYTES&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;YmJi&quot; --&gt; Output: &quot;YmJi&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;DATE&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;2016-11-03&quot; --&gt; Output: &quot;2016-11-03&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;DATETIME&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;2016-11-03T00:49:36&quot; --&gt; Output: &quot;2016-11-03T00:49:36&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;TIME&#39;</span><span class="p">:</span>
      <span class="c1"># Input: &quot;00:49:36&quot; --&gt; Output: &quot;00:49:36&quot;</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;RECORD&#39;</span><span class="p">:</span>
      <span class="c1"># Note that a schema field object supports also a RECORD type. However</span>
      <span class="c1"># when querying, the repeated and/or record fields are flattened</span>
      <span class="c1"># unless we pass the flatten_results flag as False to the source</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_row_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;NUMERIC&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;GEOGRAPHY&#39;</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Unexpected field type: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">type</span><span class="p">)</span>

<div class="viewcode-block" id="BigQueryWrapper.convert_row_to_dict"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWrapper.convert_row_to_dict">[docs]</a>  <span class="k">def</span> <span class="nf">convert_row_to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts a TableRow instance using the schema to a Python dict.&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
      <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableSchema</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">from_json_value</span><span class="p">(</span><span class="n">cell</span><span class="o">.</span><span class="n">v</span><span class="p">)</span> <span class="k">if</span> <span class="n">cell</span><span class="o">.</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">bigquery</span><span class="o">.</span><span class="n">TableFieldSchema</span><span class="p">):</span>
        <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">cell</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;v&#39;</span> <span class="ow">in</span> <span class="n">cell</span> <span class="k">else</span> <span class="kc">None</span>
      <span class="k">if</span> <span class="n">field</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;REPEATED&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
          <span class="c1"># Ideally this should never happen as repeated fields default to</span>
          <span class="c1"># returning an empty list</span>
          <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_cell_value_to_dict</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">field</span><span class="p">)</span>
                                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">value</span><span class="p">]</span>
      <span class="k">elif</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field</span><span class="o">.</span><span class="n">mode</span> <span class="o">==</span> <span class="s1">&#39;NULLABLE&#39;</span><span class="p">:</span>
          <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Received </span><span class="se">\&#39;</span><span class="s1">None</span><span class="se">\&#39;</span><span class="s1"> as the value for the field </span><span class="si">%s</span><span class="s1"> &#39;</span>
                           <span class="s1">&#39;but the field is not NULLABLE.&#39;</span> <span class="o">%</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">result</span><span class="p">[</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_cell_value_to_dict</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div></div>


<span class="c1"># -----------------------------------------------------------------------------</span>
<span class="c1"># BigQueryReader, BigQueryWriter.</span>


<div class="viewcode-block" id="BigQueryReader"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryReader">[docs]</a><span class="k">class</span> <span class="nc">BigQueryReader</span><span class="p">(</span><span class="n">dataflow_io</span><span class="o">.</span><span class="n">NativeSourceReader</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A reader for a BigQuery source.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">test_bigquery_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">use_legacy_sql</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">flatten_results</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">kms_key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span> <span class="o">=</span> <span class="n">test_bigquery_client</span>
    <span class="k">if</span> <span class="n">auth</span><span class="o">.</span><span class="n">is_running_in_gce</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">executing_project</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="s1">&#39;pipeline_options&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">source</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">GoogleCloudOptions</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># TODO(silviuc): Try to automatically get it from gcloud config info.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span> <span class="ow">and</span> <span class="n">test_bigquery_client</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
          <span class="s1">&#39;Missing executing project information. Please use the --project &#39;</span>
          <span class="s1">&#39;command line option to specify it.&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">coder</span><span class="p">,</span> <span class="n">RowAsDictJsonCoder</span><span class="p">)</span>
    <span class="c1"># Schema for the rows being read by the reader. It is initialized the</span>
    <span class="c1"># first time something gets read from the table. It is not required</span>
    <span class="c1"># for reading the field values in each row but could be useful for</span>
    <span class="c1"># getting additional details.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">use_legacy_sql</span> <span class="o">=</span> <span class="n">use_legacy_sql</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">flatten_results</span> <span class="o">=</span> <span class="n">flatten_results</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kms_key</span> <span class="o">=</span> <span class="n">kms_key</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="c1"># If table schema did not define a project we default to executing</span>
      <span class="c1"># project.</span>
      <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">project_id</span><span class="p">:</span>
        <span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="s1">&#39;SELECT * FROM [</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">];&#39;</span> <span class="o">%</span> <span class="p">(</span>
          <span class="n">project_id</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
    <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># Enforce the &quot;modes&quot; enforced by BigQuerySource.__init__.</span>
      <span class="c1"># If this exception has been raised, the BigQuerySource &quot;modes&quot; have</span>
      <span class="c1"># changed and this method will need to be updated as well.</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;BigQuerySource must have either a table or query&quot;</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">_get_source_location</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the source location (e.g. ``&quot;EU&quot;`` or ``&quot;US&quot;``) from either</span>

<span class="sd">    - :data:`source.table_reference`</span>
<span class="sd">      or</span>
<span class="sd">    - The first referenced table in :data:`source.query`</span>

<span class="sd">    See Also:</span>
<span class="sd">      - :meth:`BigQueryWrapper.get_query_location`</span>
<span class="sd">      - :meth:`BigQueryWrapper.get_table_location`</span>

<span class="sd">    Returns:</span>
<span class="sd">      Optional[str]: The source location, if any.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
      <span class="n">tr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">table_reference</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_table_location</span><span class="p">(</span>
          <span class="n">tr</span><span class="o">.</span><span class="n">projectId</span> <span class="k">if</span> <span class="n">tr</span><span class="o">.</span><span class="n">projectId</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span>
          <span class="n">tr</span><span class="o">.</span><span class="n">datasetId</span><span class="p">,</span> <span class="n">tr</span><span class="o">.</span><span class="n">tableId</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># It&#39;s a query source</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_query_location</span><span class="p">(</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">use_legacy_sql</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">BigQueryWrapper</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">create_temporary_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span> <span class="n">location</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_source_location</span><span class="p">())</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">clean_up_temporary_dataset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">)</span>

  <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">rows</span><span class="p">,</span> <span class="n">schema</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">run_query</span><span class="p">(</span>
        <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">executing_project</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">query</span><span class="p">,</span>
        <span class="n">use_legacy_sql</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_legacy_sql</span><span class="p">,</span>
        <span class="n">flatten_results</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">flatten_results</span><span class="p">):</span>
      <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
      <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="c1"># return base64 encoded bytes as byte type on python 3</span>
        <span class="c1"># which matches the behavior of Beam Java SDK</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">)):</span>
          <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;BYTES&#39;</span> <span class="ow">and</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="p">:</span>
            <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">string_value</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">v</span><span class="o">.</span><span class="n">string_value</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span><span class="p">:</span>
          <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">convert_row_to_dict</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">row</span></div>


<div class="viewcode-block" id="BigQueryWriter"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWriter">[docs]</a><span class="k">class</span> <span class="nc">BigQueryWriter</span><span class="p">(</span><span class="n">dataflow_io</span><span class="o">.</span><span class="n">NativeSinkWriter</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;The sink writer for a BigQuerySink.&quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">test_bigquery_client</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">buffer_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">sink</span> <span class="o">=</span> <span class="n">sink</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span> <span class="o">=</span> <span class="n">test_bigquery_client</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">row_as_dict</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">coder</span><span class="p">,</span> <span class="n">RowAsDictJsonCoder</span><span class="p">)</span>
    <span class="c1"># Buffer used to batch written rows so we reduce communication with the</span>
    <span class="c1"># BigQuery service.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer_flush_threshold</span> <span class="o">=</span> <span class="n">buffer_size</span> <span class="ow">or</span> <span class="mi">1000</span>
    <span class="c1"># Figure out the project, dataset, and table used for the sink.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">projectId</span>

    <span class="c1"># If table schema did not define a project we default to executing project.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="s1">&#39;pipeline_options&#39;</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">sink</span><span class="o">.</span><span class="n">pipeline_options</span><span class="o">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">GoogleCloudOptions</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">)</span>

    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">datasetId</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_reference</span><span class="o">.</span><span class="n">tableId</span>

  <span class="k">def</span> <span class="nf">_flush_rows_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">:</span>
      <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Writing </span><span class="si">%d</span><span class="s1"> rows to </span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1"> table.&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">),</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">)</span>
      <span class="n">passed</span><span class="p">,</span> <span class="n">errors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">insert_rows</span><span class="p">(</span>
          <span class="n">project_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="n">dataset_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
          <span class="n">table_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="n">rows</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span> <span class="o">=</span> <span class="p">[]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">passed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;Could not successfully insert rows to BigQuery&#39;</span>
                           <span class="s1">&#39; table [</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">]. Errors: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="n">errors</span><span class="p">))</span>

  <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span> <span class="o">=</span> <span class="n">BigQueryWrapper</span><span class="p">(</span><span class="n">client</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">test_bigquery_client</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">get_or_create_table</span><span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">table_schema</span><span class="p">,</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">create_disposition</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sink</span><span class="o">.</span><span class="n">write_disposition</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span>

  <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exception_type</span><span class="p">,</span> <span class="n">exception_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_flush_rows_buffer</span><span class="p">()</span>

<div class="viewcode-block" id="BigQueryWriter.Write"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.BigQueryWriter.Write">[docs]</a>  <span class="k">def</span> <span class="nf">Write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rows_buffer_flush_threshold</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_flush_rows_buffer</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="RowAsDictJsonCoder"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.RowAsDictJsonCoder">[docs]</a><span class="k">class</span> <span class="nc">RowAsDictJsonCoder</span><span class="p">(</span><span class="n">coders</span><span class="o">.</span><span class="n">Coder</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;A coder for a table row (represented as a dict) to/from a JSON string.</span>

<span class="sd">  This is the default coder for sources and sinks if the coder argument is not</span>
<span class="sd">  specified.</span>
<span class="sd">  &quot;&quot;&quot;</span>

<div class="viewcode-block" id="RowAsDictJsonCoder.encode"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.RowAsDictJsonCoder.encode">[docs]</a>  <span class="k">def</span> <span class="nf">encode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_row</span><span class="p">):</span>
    <span class="c1"># The normal error when dumping NAN/INF values is:</span>
    <span class="c1"># ValueError: Out of range float values are not JSON compliant</span>
    <span class="c1"># This code will catch this error to emit an error that explains</span>
    <span class="c1"># to the programmer that they have used NAN/INF values.</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># on python 3 base64-encoded bytes are decoded to strings</span>
      <span class="c1"># before being send to bq</span>
      <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">table_row</span><span class="p">):</span>
          <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="nb">bytes</span><span class="p">:</span>
            <span class="n">table_row</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
          <span class="n">table_row</span><span class="p">,</span> <span class="n">allow_nan</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">default_encoder</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">JSON_COMPLIANCE_ERROR</span><span class="p">))</span></div>

<div class="viewcode-block" id="RowAsDictJsonCoder.decode"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.RowAsDictJsonCoder.decode">[docs]</a>  <span class="k">def</span> <span class="nf">decode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoded_table_row</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">encoded_table_row</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="RetryStrategy"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.RetryStrategy">[docs]</a><span class="k">class</span> <span class="nc">RetryStrategy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="n">RETRY_ALWAYS</span> <span class="o">=</span> <span class="s1">&#39;RETRY_ALWAYS&#39;</span>
  <span class="n">RETRY_NEVER</span> <span class="o">=</span> <span class="s1">&#39;RETRY_NEVER&#39;</span>
  <span class="n">RETRY_ON_TRANSIENT_ERROR</span> <span class="o">=</span> <span class="s1">&#39;RETRY_ON_TRANSIENT_ERROR&#39;</span>

  <span class="n">_NON_TRANSIENT_ERRORS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;invalid&#39;</span><span class="p">,</span> <span class="s1">&#39;invalidQuery&#39;</span><span class="p">,</span> <span class="s1">&#39;notImplemented&#39;</span><span class="p">}</span>

<div class="viewcode-block" id="RetryStrategy.should_retry"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.RetryStrategy.should_retry">[docs]</a>  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">should_retry</span><span class="p">(</span><span class="n">strategy</span><span class="p">,</span> <span class="n">error_message</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_ALWAYS</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_NEVER</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="p">(</span><span class="n">strategy</span> <span class="o">==</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">RETRY_ON_TRANSIENT_ERROR</span> <span class="ow">and</span>
          <span class="n">error_message</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">RetryStrategy</span><span class="o">.</span><span class="n">_NON_TRANSIENT_ERRORS</span><span class="p">):</span>
      <span class="k">return</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="kc">False</span></div></div>


<div class="viewcode-block" id="AppendDestinationsFn"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.AppendDestinationsFn">[docs]</a><span class="k">class</span> <span class="nc">AppendDestinationsFn</span><span class="p">(</span><span class="n">DoFn</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Adds the destination to an element, making it a KV pair.</span>

<span class="sd">  Outputs a PCollection of KV-pairs where the key is a TableReference for the</span>
<span class="sd">  destination, and the value is the record itself.</span>

<span class="sd">  Experimental; no backwards compatibility guarantees.</span>
<span class="sd">  &quot;&quot;&quot;</span>

  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">destination</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">destination</span> <span class="o">=</span> <span class="n">AppendDestinationsFn</span><span class="o">.</span><span class="n">_get_table_fn</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_value_provider_or_static_val</span><span class="p">(</span><span class="n">elm</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elm</span><span class="p">,</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">ValueProvider</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">elm</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># The type argument is a NoOp, because we assume the argument already has</span>
      <span class="c1"># the proper formatting.</span>
      <span class="k">return</span> <span class="n">value_provider</span><span class="o">.</span><span class="n">StaticValueProvider</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">elm</span><span class="p">)</span>

  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">_get_table_fn</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">callable</span><span class="p">(</span><span class="n">destination</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">destination</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">return</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">AppendDestinationsFn</span><span class="o">.</span><span class="n">_value_provider_or_static_val</span><span class="p">(</span>
          <span class="n">destination</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

<div class="viewcode-block" id="AppendDestinationsFn.process"><a class="viewcode-back" href="../../../../apache_beam.io.gcp.bigquery_tools.html#apache_beam.io.gcp.bigquery_tools.AppendDestinationsFn.process">[docs]</a>  <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">side_inputs</span><span class="p">):</span>
    <span class="k">yield</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">destination</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">side_inputs</span><span class="p">),</span> <span class="n">element</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           <div class="articleComments">
            
           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright .

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../../../',
            VERSION:'',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>